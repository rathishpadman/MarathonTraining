{% extends "base.html" %}

{% block title %}Community Dashboard - Marathon Training{% endblock %}

{% block content %}
<style>
    body {
        background: linear-gradient(135deg, #065f46 0%, #0F766E 50%, #14B8A6 100%);
        min-height: 100vh;
        color: white;
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .header {
        text-align: center;
        margin-bottom: 40px;
    }

    .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        color: white;
    }

    .header p {
        font-size: 1.2rem;
        opacity: 0.9;
    }

    .live-indicator {
        display: inline-block;
        background: rgba(255, 255, 255, 0.1);
        padding: 10px 20px;
        border-radius: 25px;
        margin-top: 20px;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .live-dot {
        display: inline-block;
        width: 8px;
        height: 8px;
        background: #10B981;
        border-radius: 50%;
        margin-right: 8px;
        animation: pulse 2s infinite;
    }

    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }

    .kpi-card {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        transition: transform 0.3s ease;
    }

    .kpi-card:hover {
        transform: translateY(-5px);
    }

    .kpi-icon {
        font-size: 2rem;
        margin-bottom: 15px;
        color: #FBBF24;
    }

    .kpi-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 10px;
        color: white;
    }

    .kpi-label {
        font-size: 1rem;
        opacity: 0.9;
        margin-bottom: 10px;
    }

    .kpi-detail {
        font-size: 0.85rem;
        opacity: 0.7;
    }

    .kpi-trend {
        color: #10B981;
        font-size: 0.9rem;
        font-weight: bold;
        margin-bottom: 10px;
    }

    .section {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        flex-wrap: wrap;
        gap: 15px;
    }

    .section-title {
        font-size: 1.8rem;
        font-weight: bold;
        color: white;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .section-icon {
        font-size: 1.5rem;
        color: #FBBF24;
    }

    .filters {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .filter-btn {
        padding: 8px 16px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .filter-btn.active,
    .filter-btn:hover {
        background: #14B8A6;
        transform: translateY(-2px);
    }

    .athlete-card {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
        transition: all 0.3s ease;
        position: relative;
    }

    .athlete-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .athlete-rank {
        position: absolute;
        top: -15px;
        right: 25px;
        width: 50px;
        height: 50px;
        background: #FBBF24;
        color: #1F2937;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.2rem;
        border: 3px solid white;
    }

    .athlete-rank.gold {
        background: linear-gradient(135deg, #FFD700, #FFA500);
    }

    .athlete-rank.silver {
        background: linear-gradient(135deg, #C0C0C0, #A8A8A8);
    }

    .athlete-rank.bronze {
        background: linear-gradient(135deg, #CD7F32, #B8860B);
    }

    .athlete-content {
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: 25px;
        align-items: center;
    }

    .athlete-avatar {
        width: 60px;
        height: 60px;
        background: #14B8A6;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: bold;
        color: white;
    }

    .athlete-name {
        font-size: 1.3rem;
        font-weight: bold;
        margin-bottom: 15px;
        color: white;
    }

    .athlete-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
    }

    .stat-item {
        text-align: center;
    }

    .stat-value {
        font-size: 1.1rem;
        font-weight: bold;
        color: #5EEAD4;
        display: block;
    }

    .stat-label {
        font-size: 0.8rem;
        opacity: 0.7;
        margin-top: 3px;
    }

    .athlete-badges {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: bold;
        color: white;
    }

    .badge.streak {
        background: #F59E0B;
    }

    .badge.achievement {
        background: #8B5CF6;
    }

    .badge.pr {
        background: #10B981;
    }

    .athlete-actions {
        display: flex;
        flex-direction: column;
        gap: 10px;
        min-width: 120px;
    }

    .action-btn {
        padding: 8px 16px;
        border-radius: 20px;
        border: none;
        font-weight: bold;
        font-size: 0.85rem;
        cursor: pointer;
        text-decoration: none;
        text-align: center;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
    }

    .btn-primary {
        background: #14B8A6;
        color: white;
    }

    .btn-secondary {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .action-btn:hover {
        transform: translateY(-2px);
    }

    .charts-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
    }

    .chart-container {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 15px;
        padding: 25px;
        min-height: 300px;
    }

    .chart-title {
        font-size: 1.3rem;
        font-weight: bold;
        color: white;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .activity-stream {
        max-height: 400px;
        overflow-y: auto;
    }

    .activity-item {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 10px;
        border-left: 4px solid #14B8A6;
        transition: all 0.3s ease;
    }

    .activity-item:hover {
        transform: translateX(4px);
        background: rgba(255, 255, 255, 0.1);
    }

    .activity-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .activity-type {
        font-weight: bold;
        color: white;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .activity-time {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.85rem;
    }

    .activity-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 10px;
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.9rem;
    }

    .milestones-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
    }

    .milestone-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 20px;
        transition: all 0.3s ease;
    }

    .milestone-card:hover {
        transform: translateY(-3px);
        background: rgba(255, 255, 255, 0.1);
    }

    .milestone-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 10px;
    }

    .milestone-icon {
        width: 40px;
        height: 40px;
        background: #FBBF24;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        color: #1F2937;
    }

    .milestone-info h4 {
        color: white;
        font-weight: bold;
        margin: 0 0 5px 0;
    }

    .milestone-info p {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.85rem;
        margin: 0;
    }

    .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100px;
        color: rgba(255, 255, 255, 0.7);
    }

    .error {
        text-align: center;
        padding: 40px;
        color: rgba(255, 255, 255, 0.7);
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
        .charts-grid {
            grid-template-columns: 1fr;
        }
        
        .athlete-content {
            grid-template-columns: auto 1fr;
            gap: 20px;
        }
        
        .athlete-actions {
            grid-column: 1 / -1;
            flex-direction: row;
            justify-content: center;
            margin-top: 15px;
        }
    }

    @media (max-width: 768px) {
        .container {
            padding: 10px;
        }
        
        .section-header {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .athlete-content {
            grid-template-columns: 1fr;
            text-align: center;
            gap: 15px;
        }
        
        .athlete-rank {
            position: static;
            margin: 0 auto 15px;
        }
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* Ensure canvas and chart transparency */
    canvas {
        background: transparent !important;
        background-color: transparent !important;
    }

    /* Chart.js specific overrides */
    .chart-container canvas {
        background: transparent !important;
        background-color: transparent !important;
    }

    /* Override Chart.js default white background */
    .chartjs-size-monitor,
    .chartjs-size-monitor-expand,
    .chartjs-size-monitor-shrink {
        background: transparent !important;
        background-color: transparent !important;
    }

    /* Force chart background area to be transparent */
    .chart-container {
        background: rgba(255, 255, 255, 0.08) !important;
        position: relative;
    }

    .chart-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: transparent !important;
        z-index: -1;
    }

    /* Force all white backgrounds to be transparent */
    * {
        background-color: transparent !important;
    }

    /* Target Chart.js specific elements */
    .chartjs-render-monitor {
        background: transparent !important;
        background-color: transparent !important;
    }

    /* Target any divs or containers that might have white backgrounds */
    div, section, article, main, aside, header, footer, nav {
        background: transparent !important;
        background-color: transparent !important;
    }

    /* Ensure canvas elements are always transparent */
    canvas, canvas * {
        background: transparent !important;
        background-color: transparent !important;
    }

    /* Override specific elements that need backgrounds */
    body {
        background: linear-gradient(135deg, #065f46 0%, #0F766E 50%, #14B8A6 100%) !important;
    }

    .kpi-card, .section, .chart-container, .athlete-card, .activity-item, .milestone-card {
        background: rgba(255, 255, 255, 0.1) !important;
        backdrop-filter: blur(10px) !important;
    }

    .live-indicator, .filter-btn {
        background: rgba(255, 255, 255, 0.1) !important;
    }

    .athlete-rank {
        background: #FBBF24 !important;
    }

    .athlete-rank.gold {
        background: linear-gradient(135deg, #FFD700, #FFA500) !important;
    }

    .athlete-rank.silver {
        background: linear-gradient(135deg, #C0C0C0, #A8A8A8) !important;
    }

    .athlete-rank.bronze {
        background: linear-gradient(135deg, #CD7F32, #B8860B) !important;
    }

    .athlete-avatar {
        background: #14B8A6 !important;
    }

    .milestone-icon {
        background: #FBBF24 !important;
    }

    .action-btn.btn-primary {
        background: #14B8A6 !important;
    }

    .action-btn.btn-secondary {
        background: rgba(255, 255, 255, 0.1) !important;
    }

    .badge.streak {
        background: #F59E0B !important;
    }

    .badge.achievement {
        background: #8B5CF6 !important;
    }

    .badge.pr {
        background: #10B981 !important;
    }
</style>

<div class="container">
    <!-- Header -->
    <div class="header">
        <h1>🏃‍♂️ Community Dashboard</h1>
        <p>Track progress, compete with friends, and achieve your marathon goals together</p>
        <div class="live-indicator">
            <span class="live-dot"></span>
            Live Community Activity
        </div>
    </div>

    <!-- Community KPIs -->
    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-icon">👥</div>
            <div class="kpi-trend">📈 +12%</div>
            <div class="kpi-value" id="totalAthletes">0</div>
            <div class="kpi-label">Active Athletes</div>
            <div class="kpi-detail">Training together this week</div>
        </div>

        <div class="kpi-card">
            <div class="kpi-icon">🏃‍♂️</div>
            <div class="kpi-trend">📈 +8%</div>
            <div class="kpi-value" id="totalDistance">0 km</div>
            <div class="kpi-label">Community Distance</div>
            <div class="kpi-detail">Total kilometers logged this month</div>
        </div>

        <div class="kpi-card">
            <div class="kpi-icon">⚡</div>
            <div class="kpi-trend">📈 +15%</div>
            <div class="kpi-value" id="totalActivities">0</div>
            <div class="kpi-label">Total Activities</div>
            <div class="kpi-detail">Workouts completed this week</div>
        </div>

        <div class="kpi-card">
            <div class="kpi-icon">⏱️</div>
            <div class="kpi-trend">📈 -3%</div>
            <div class="kpi-value" id="avgPace">0:00</div>
            <div class="kpi-label">Average Pace</div>
            <div class="kpi-detail">Community average per kilometer</div>
        </div>
    </div>

    <!-- Performance Leaderboard -->
    <div class="section">
        <div class="section-header">
            <div class="section-title">
                <span class="section-icon">🏆</span>
                Performance Leaderboard
            </div>
            <div class="filters">
                <button class="filter-btn active" data-filter="weekly">This Week</button>
                <button class="filter-btn" data-filter="monthly">This Month</button>
                <button class="filter-btn" data-filter="alltime">All Time</button>
            </div>
        </div>
        
        <div id="leaderboardContent">
            <div class="loading">Loading leaderboard...</div>
        </div>
    </div>

    <!-- Charts and Activity Stream -->
    <div class="charts-grid">
        <div class="chart-container">
            <div class="chart-title">
                <span class="section-icon">📊</span>
                Community Training Trends
            </div>
            <div id="trainingTrendsChart" style="height: 300px; width: 100%;"></div>
        </div>

        <div class="section">
            <div class="chart-title">
                <span class="section-icon">📈</span>
                Live Activity Feed
            </div>
            <div class="activity-stream" id="activityStreamContent">
                <div class="loading">Loading activities...</div>
            </div>
        </div>
    </div>

    <!-- Training Load Distribution -->
    <div class="chart-container">
        <div class="chart-title">
            <span class="section-icon">💪</span>
            Training Load Distribution
        </div>
        <div id="trainingLoadChart" style="height: 300px; width: 100%;"></div>
    </div>

    <!-- Recent Milestones -->
    <div class="section">
        <div class="chart-title">
            <span class="section-icon">⭐</span>
            Recent Community Achievements
        </div>
        
        <div class="milestones-grid">
            <div class="milestone-card">
                <div class="milestone-header">
                    <div class="milestone-icon">🏅</div>
                    <div class="milestone-info">
                        <h4>Marathon Goal Achieved</h4>
                        <p>Sarah completed her first sub-4:00 marathon!</p>
                    </div>
                </div>
            </div>

            <div class="milestone-card">
                <div class="milestone-header">
                    <div class="milestone-icon">🔥</div>
                    <div class="milestone-info">
                        <h4>Training Streak</h4>
                        <p>Mike reached a 30-day consecutive training streak</p>
                    </div>
                </div>
            </div>

            <div class="milestone-card">
                <div class="milestone-header">
                    <div class="milestone-icon">🎯</div>
                    <div class="milestone-info">
                        <h4>Community Milestone</h4>
                        <p>1,000km combined distance this month!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Community Dashboard loading...');
    loadCommunityData();
    setupEventListeners();
    
    // Force transparency continuously
    setInterval(forceTransparency, 500);
    
    // Auto-refresh every 30 seconds
    setInterval(loadCommunityData, 30000);
});

function forceTransparency() {
    // Force all canvas elements to be transparent
    document.querySelectorAll('canvas').forEach(canvas => {
        canvas.style.backgroundColor = 'transparent';
        canvas.style.background = 'none';
        
        // Also check parent containers
        let parent = canvas.parentElement;
        while (parent && parent !== document.body) {
            if (parent.style.backgroundColor === 'white' || 
                parent.style.backgroundColor === '#ffffff' ||
                parent.style.backgroundColor === 'rgb(255, 255, 255)') {
                parent.style.backgroundColor = 'transparent';
            }
            parent = parent.parentElement;
        }
    });
    
    // Target Chart.js specific classes
    document.querySelectorAll('.chartjs-render-monitor').forEach(el => {
        el.style.backgroundColor = 'transparent';
        el.style.background = 'none';
    });
    
    // Force any white backgrounds to transparent
    document.querySelectorAll('*').forEach(el => {
        const computedStyle = window.getComputedStyle(el);
        if (computedStyle.backgroundColor === 'rgb(255, 255, 255)' || 
            computedStyle.backgroundColor === 'white' ||
            computedStyle.backgroundColor === '#ffffff') {
            el.style.backgroundColor = 'transparent';
        }
    });
}

function setupEventListeners() {
    // Filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            loadLeaderboard(this.dataset.filter);
        });
    });
}

async function loadCommunityData() {
    try {
        console.log('Loading community overview...');
        const response = await fetch('/api/community/overview');
        const data = await response.json();
        
        console.log('Community data loaded:', data);
        
        // Update KPIs
        if (data.kpis) {
            updateKPIs(data.kpis);
        }
        
        // Render leaderboard
        if (data.leaderboard && data.leaderboard.length > 0) {
            renderLeaderboard(data.leaderboard);
        } else {
            showNoAthletes();
        }
        
        // Render charts
        if (data.communityTrends) {
            renderTrainingTrendsChart(data.communityTrends);
        }
        
        if (data.trainingLoadDistribution) {
            renderTrainingLoadChart(data.trainingLoadDistribution);
        }
        
        // Load activity stream
        loadActivityStream();
        
    } catch (error) {
        console.error('Error loading community data:', error);
        showErrorState();
    }
}

function updateKPIs(kpis) {
    document.getElementById('totalAthletes').textContent = kpis.totalAthletes || 0;
    document.getElementById('totalDistance').textContent = `${Math.round(kpis.totalDistance || 0)} km`;
    document.getElementById('totalActivities').textContent = kpis.totalActivities || 0;
    
    if (kpis.avgPace) {
        const minutes = Math.floor(kpis.avgPace);
        const seconds = Math.round((kpis.avgPace - minutes) * 60);
        document.getElementById('avgPace').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }
}

function renderLeaderboard(athletes) {
    console.log('Rendering leaderboard:', athletes);
    const container = document.getElementById('leaderboardContent');
    
    if (!athletes || athletes.length === 0) {
        showNoAthletes();
        return;
    }
    
    container.innerHTML = athletes.map((athlete, index) => {
        const rank = index + 1;
        const rankClass = rank === 1 ? 'gold' : rank === 2 ? 'silver' : rank === 3 ? 'bronze' : '';
        const initial = athlete.name ? athlete.name.charAt(0).toUpperCase() : 'A';
        
        return `
            <div class="athlete-card">
                <div class="athlete-rank ${rankClass}">${rank}</div>
                <div class="athlete-content">
                    <div class="athlete-avatar">${initial}</div>
                    <div class="athlete-info">
                        <div class="athlete-name">${athlete.name || 'Anonymous Athlete'}</div>
                        <div class="athlete-stats">
                            <div class="stat-item">
                                <span class="stat-value">${Math.round(athlete.distance || 0)} km</span>
                                <span class="stat-label">Distance</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">${athlete.activities || 0}</span>
                                <span class="stat-label">Activities</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">${formatPace(athlete.avg_pace)}</span>
                                <span class="stat-label">Avg Pace</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">${Math.round(athlete.avg_hr || 0)} bpm</span>
                                <span class="stat-label">Avg HR</span>
                            </div>
                        </div>
                        <div class="athlete-badges">
                            ${rank <= 3 ? '<span class="badge achievement">🏆 Top Performer</span>' : ''}
                            ${athlete.activities >= 5 ? '<span class="badge streak">🔥 Active Streak</span>' : ''}
                            ${athlete.distance > 50 ? '<span class="badge pr">🎯 Distance Goal</span>' : ''}
                        </div>
                    </div>
                    <div class="athlete-actions">
                        <a href="/dashboard?athlete_id=${athlete.id}" class="action-btn btn-primary">
                            📊 View Dashboard
                        </a>
                        <a href="/api/athletes/${athlete.id}/race-prediction?distance=Marathon" class="action-btn btn-secondary">
                            🔮 Race Prediction
                        </a>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function formatPace(pace) {
    if (!pace) return '0:00';
    const minutes = Math.floor(pace);
    const seconds = Math.round((pace - minutes) * 60);
    return `${minutes}:${seconds.toString().padStart(2, '0')}`;
}

function showNoAthletes() {
    document.getElementById('leaderboardContent').innerHTML = `
        <div class="error">
            <div style="font-size: 3rem; margin-bottom: 20px;">🏃‍♂️</div>
            <h3>No Athletes Yet</h3>
            <p style="margin-bottom: 30px;">Be the first to join our marathon training community!</p>
            <a href="/auth/strava" class="action-btn btn-primary" style="display: inline-flex;">
                🔗 Connect with Strava
            </a>
        </div>
    `;
}

function showErrorState() {
    document.getElementById('leaderboardContent').innerHTML = `
        <div class="error">
            <div style="font-size: 3rem; margin-bottom: 20px;">⚠️</div>
            <h3>Unable to Load Data</h3>
            <p style="margin-bottom: 30px;">Please try refreshing the page or check your connection.</p>
            <button onclick="loadCommunityData()" class="action-btn btn-primary">
                🔄 Retry
            </button>
        </div>
    `;
}

async function loadActivityStream() {
    try {
        const response = await fetch('/api/community/activity-stream');
        const data = await response.json();
        
        console.log('Activity stream loaded:', data);
        if (data.stream) {
            renderActivityStream(data.stream);
        }
    } catch (error) {
        console.error('Error loading activity stream:', error);
        document.getElementById('activityStreamContent').innerHTML = `
            <div class="error">Unable to load recent activities</div>
        `;
    }
}

function renderActivityStream(activities) {
    const container = document.getElementById('activityStreamContent');
    
    if (!activities || activities.length === 0) {
        container.innerHTML = `<div class="error">No recent activities</div>`;
        return;
    }
    
    container.innerHTML = activities.map(activity => {
        if (activity.type === 'milestone') {
            return `
                <div class="activity-item">
                    <div class="activity-header">
                        <div class="activity-type">
                            🏆 Achievement Unlocked
                        </div>
                        <div class="activity-time">${activity.relative_time}</div>
                    </div>
                    <div class="activity-details">
                        <div><strong>${activity.athlete_name}</strong> achieved <strong>${activity.achievement}</strong></div>
                        <div>${activity.details}</div>
                    </div>
                </div>
            `;
        } else {
            return `
                <div class="activity-item">
                    <div class="activity-header">
                        <div class="activity-type">
                            🏃‍♂️ ${activity.activity_name || 'Training Run'}
                        </div>
                        <div class="activity-time">${activity.relative_time}</div>
                    </div>
                    <div class="activity-details">
                        <div><strong>${activity.distance_km} km</strong></div>
                        <div><strong>${activity.pace}</strong> /km</div>
                        <div><strong>${activity.athlete_name}</strong></div>
                    </div>
                </div>
            `;
        }
    }).join('');
}

// Custom SVG chart rendering functions with complete transparency
function renderTrainingTrendsChart(data) {
    console.log('Rendering SVG chart with data:', data);
    const container = document.getElementById('trainingTrendsChart');
    if (!container) return;
    
    const width = container.clientWidth;
    const height = 300;
    const margin = { top: 20, right: 30, bottom: 60, left: 50 };
    const chartWidth = width - margin.left - margin.right;
    const chartHeight = height - margin.top - margin.bottom;
    
    // Clear previous chart
    container.innerHTML = '';
    
    // Create SVG with transparent background
    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('width', width);
    svg.setAttribute('height', height);
    svg.style.background = 'transparent';
    
    // Create main group
    const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    g.setAttribute('transform', `translate(${margin.left},${margin.top})`);
    
    const labels = data.labels;
    const datasets = data.datasets;
    
    // Calculate scales
    const xStep = chartWidth / (labels.length - 1);
    const maxY = Math.max(...datasets.flatMap(d => d.data));
    const yScale = chartHeight / (maxY * 1.1);
    
    // Draw grid lines
    for (let i = 0; i <= 5; i++) {
        const y = (chartHeight / 5) * i;
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', 0);
        line.setAttribute('x2', chartWidth);
        line.setAttribute('y1', y);
        line.setAttribute('y2', y);
        line.setAttribute('stroke', 'rgba(255, 255, 255, 0.1)');
        line.setAttribute('stroke-width', 1);
        g.appendChild(line);
    }
    
    // Draw vertical grid lines
    labels.forEach((label, i) => {
        const x = i * xStep;
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', x);
        line.setAttribute('x2', x);
        line.setAttribute('y1', 0);
        line.setAttribute('y2', chartHeight);
        line.setAttribute('stroke', 'rgba(255, 255, 255, 0.05)');
        line.setAttribute('stroke-width', 1);
        g.appendChild(line);
    });
    
    // Draw datasets
    datasets.forEach((dataset, datasetIndex) => {
        const color = datasetIndex === 0 ? '#4BC0C0' : '#FF6384';
        
        // Create path for line
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        let pathData = '';
        
        dataset.data.forEach((value, i) => {
            const x = i * xStep;
            const y = chartHeight - (value * yScale);
            pathData += (i === 0 ? 'M' : 'L') + x + ',' + y;
        });
        
        path.setAttribute('d', pathData);
        path.setAttribute('stroke', color);
        path.setAttribute('stroke-width', 3);
        path.setAttribute('fill', 'none');
        path.setAttribute('stroke-linecap', 'round');
        path.setAttribute('stroke-linejoin', 'round');
        g.appendChild(path);
        
        // Add points
        dataset.data.forEach((value, i) => {
            const x = i * xStep;
            const y = chartHeight - (value * yScale);
            
            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('cx', x);
            circle.setAttribute('cy', y);
            circle.setAttribute('r', 4);
            circle.setAttribute('fill', color);
            circle.setAttribute('stroke', 'white');
            circle.setAttribute('stroke-width', 2);
            g.appendChild(circle);
            
            // Add tooltip on hover
            circle.addEventListener('mouseenter', function() {
                this.setAttribute('r', 6);
                showTooltip(x + margin.left, y + margin.top, `${dataset.label}: ${value}`);
            });
            
            circle.addEventListener('mouseleave', function() {
                this.setAttribute('r', 4);
                hideTooltip();
            });
        });
    });
    
    // Draw X-axis labels
    labels.forEach((label, i) => {
        const x = i * xStep;
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', x);
        text.setAttribute('y', chartHeight + 20);
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('fill', 'rgba(255, 255, 255, 0.8)');
        text.setAttribute('font-size', '12');
        text.textContent = label;
        g.appendChild(text);
    });
    
    // Draw Y-axis labels
    for (let i = 0; i <= 5; i++) {
        const value = (maxY * 1.1 / 5) * (5 - i);
        const y = (chartHeight / 5) * i;
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', -10);
        text.setAttribute('y', y + 4);
        text.setAttribute('text-anchor', 'end');
        text.setAttribute('fill', 'rgba(255, 255, 255, 0.8)');
        text.setAttribute('font-size', '12');
        text.textContent = Math.round(value * 10) / 10;
        g.appendChild(text);
    }
    
    svg.appendChild(g);
    container.appendChild(svg);
    
    // Add legend
    const legend = document.createElement('div');
    legend.style.cssText = 'display: flex; justify-content: center; gap: 20px; margin-top: 15px;';
    
    datasets.forEach((dataset, i) => {
        const color = i === 0 ? '#4BC0C0' : '#FF6384';
        const item = document.createElement('div');
        item.style.cssText = 'display: flex; align-items: center; gap: 8px; color: white; font-size: 12px;';
        item.innerHTML = `<div style="width: 12px; height: 12px; background: ${color}; border-radius: 2px;"></div>${dataset.label}`;
        legend.appendChild(item);
    });
    
    container.appendChild(legend);
}

function renderTrainingLoadChart(data) {
    const container = document.getElementById('trainingLoadChart');
    if (!container) return;
    
    const width = container.clientWidth;
    const height = 300;
    const radius = Math.min(width, height) / 2 - 40;
    const centerX = width / 2;
    const centerY = height / 2;
    
    // Clear previous chart
    container.innerHTML = '';
    
    // Create SVG with transparent background
    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('width', width);
    svg.setAttribute('height', height);
    svg.style.background = 'transparent';
    
    const colors = [
        '#14B8A6', '#F97316', '#8B5CF6', '#EC4899', '#FBBF24'
    ];
    
    // Calculate angles
    const total = data.data.reduce((sum, val) => sum + val, 0);
    let currentAngle = -90; // Start from top
    
    data.data.forEach((value, i) => {
        const percentage = value / total;
        const angle = percentage * 360;
        
        // Create path for pie slice
        const startAngle = (currentAngle * Math.PI) / 180;
        const endAngle = ((currentAngle + angle) * Math.PI) / 180;
        
        const x1 = centerX + radius * Math.cos(startAngle);
        const y1 = centerY + radius * Math.sin(startAngle);
        const x2 = centerX + radius * Math.cos(endAngle);
        const y2 = centerY + radius * Math.sin(endAngle);
        
        const largeArcFlag = angle > 180 ? 1 : 0;
        
        const pathData = [
            `M ${centerX} ${centerY}`,
            `L ${x1} ${y1}`,
            `A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2}`,
            'Z'
        ].join(' ');
        
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', pathData);
        path.setAttribute('fill', colors[i] || colors[0]);
        path.setAttribute('stroke', 'rgba(255, 255, 255, 0.3)');
        path.setAttribute('stroke-width', 2);
        
        // Add hover effects
        path.addEventListener('mouseenter', function() {
            this.style.filter = 'brightness(1.2)';
            const midAngle = (startAngle + endAngle) / 2;
            const tooltipX = centerX + (radius * 0.7) * Math.cos(midAngle);
            const tooltipY = centerY + (radius * 0.7) * Math.sin(midAngle);
            showTooltip(tooltipX, tooltipY, `${data.labels[i]}: ${value.toFixed(1)}km`);
        });
        
        path.addEventListener('mouseleave', function() {
            this.style.filter = 'brightness(1)';
            hideTooltip();
        });
        
        svg.appendChild(path);
        currentAngle += angle;
    });
    
    container.appendChild(svg);
    
    // Add legend
    const legend = document.createElement('div');
    legend.style.cssText = 'display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-top: 20px;';
    
    data.labels.forEach((label, i) => {
        const item = document.createElement('div');
        item.style.cssText = 'display: flex; align-items: center; gap: 8px; color: white; font-size: 12px;';
        item.innerHTML = `<div style="width: 12px; height: 12px; background: ${colors[i]}; border-radius: 2px;"></div>${label}`;
        legend.appendChild(item);
    });
    
    container.appendChild(legend);
}

// Tooltip functions
function showTooltip(x, y, text) {
    hideTooltip(); // Remove any existing tooltip
    
    const tooltip = document.createElement('div');
    tooltip.id = 'chart-tooltip';
    tooltip.style.cssText = `
        position: absolute;
        left: ${x}px;
        top: ${y - 30}px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        pointer-events: none;
        z-index: 1000;
        transform: translateX(-50%);
        border: 1px solid rgba(255, 255, 255, 0.2);
    `;
    tooltip.textContent = text;
    document.body.appendChild(tooltip);
}

function hideTooltip() {
    const tooltip = document.getElementById('chart-tooltip');
    if (tooltip) {
        tooltip.remove();
    }
}

async function loadLeaderboard(period = 'weekly') {
    try {
        console.log(`Loading ${period} leaderboard...`);
        const response = await fetch(`/api/community/leaderboard?period=${period}`);
        const data = await response.json();
        
        if (data.leaderboard) {
            renderLeaderboard(data.leaderboard);
        }
    } catch (error) {
        console.error('Error loading leaderboard:', error);
        showErrorState();
    }
}
</script>
{% endblock %}