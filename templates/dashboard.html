{% extends "base.html" %}

{% block title %}Dashboard - Marathon Training{% endblock %}

{% block content %}
<div class="row">
    <!-- Welcome Section -->
    <div class="col-12">
        <div class="card-glassmorphism p-4 mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="text-white mb-2">
                        <i class="fas fa-tachometer-alt me-2"></i>
                        Training Dashboard
                    </h1>
                    <p class="text-white-50 mb-0">Monitor your marathon training progress and performance metrics</p>
                </div>
                <div class="strava-branding" style="display: flex; gap: 8px; align-items: center;">
                    <div style="background: #fc4c02; padding: 4px 12px; border-radius: 4px; color: white; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; font-size: 12px;">
                        CONNECT WITH STRAVA
                    </div>
                    <div style="background: #000; padding: 3px 8px; border-radius: 3px;">
                        <span style="color: #fc4c02; font-weight: bold; font-size: 10px;">POWERED BY</span>
                        <span style="color: #fc4c02; font-weight: bold; font-size: 12px; margin-left: 3px;">STRAVA</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Athlete Selection -->
<div class="row mb-4" id="athleteSelection" style="display: none;">
    <div class="col-12">
        <div class="card-glassmorphism p-3">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <label for="athleteSelect" class="form-label text-white">Select Athlete:</label>
                    <select id="athleteSelect" class="form-control">
                        <option value="">Loading athletes...</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <div class="text-center">
                        <button class="btn filter-button" id="syncButton" onclick="syncAthleteData()" title="Sync Strava Data">
                            <i class="fas fa-sync-alt"></i> Sync Data
                        </button>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="text-end">
                        <span class="text-white-50">Athletes: </span>
                        <span id="athleteCount" class="text-white fw-bold">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Key Metrics Row -->
<div class="row" id="metricsSection" style="display: none;">
    <div class="col-md-3 col-sm-6">
        <div class="card-glassmorphism metric-card">
            <div id="metric-total_distance" class="metric-value">0.0</div>
            <div class="metric-label">Total Distance (km)</div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6">
        <div class="card-glassmorphism metric-card">
            <div id="metric-total_activities" class="metric-value">0</div>
            <div class="metric-label">Activities</div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6">
        <div class="card-glassmorphism metric-card">
            <div id="metric-avg_pace" class="metric-value">0:00</div>
            <div class="metric-label">Avg Pace</div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6">
        <div class="card-glassmorphism metric-card">
            <div id="metric-training_load" class="metric-value">0</div>
            <div class="metric-label">Training Load</div>
        </div>
    </div>
</div>

<!-- Charts and Analysis Row -->
<div class="row mt-4" id="chartsSection" style="display: none;">
    <!-- Weekly Progress Chart -->
    <div class="col-lg-8">
        <div class="card-glassmorphism p-4">
            <h4 class="text-white mb-3">
                <i class="fas fa-chart-line me-2"></i>
                Weekly Training Progress
            </h4>
            <div class="chart-container">
                <canvas id="weeklyProgressChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Training Status -->
    <div class="col-lg-4">
        <div class="card-glassmorphism p-4 h-100">
            <h4 class="text-white mb-3">
                <i class="fas fa-chart-pie me-2"></i>
                Training Status
            </h4>
            <div class="chart-container">
                <canvas id="statusChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activities and Insights -->
<div class="row mt-4" id="activitiesSection" style="display: none;">
    <!-- Recent Activities -->
    <div class="col-lg-6">
        <div class="card-glassmorphism p-4">
            <h4 class="text-white mb-3">
                <i class="fas fa-running me-2"></i>
                Recent Activities
            </h4>
            <div id="recentActivities" class="activity-list">
                <div class="text-center text-white-50 p-4">
                    <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                    <p>Loading activities...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Race Predictions -->
    <div class="col-lg-6">
        <div class="card-glassmorphism p-4">
            <h4 class="text-white mb-3">
                <i class="fas fa-trophy me-2"></i>
                Race Predictions
            </h4>
            <div id="racePredictions">
                <div class="text-center text-white-50 p-4">
                    <i class="fas fa-stopwatch fa-2x mb-2"></i>
                    <p>Select an athlete to view race predictions</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Team Overview (if multiple athletes) -->
<div class="row mt-4" id="teamSection" style="display: none;">
    <div class="col-12">
        <div class="card-glassmorphism p-4">
            <h4 class="text-white mb-3">
                <i class="fas fa-users me-2"></i>
                Team Overview
            </h4>
            <div class="row" id="teamOverview">
                <!-- Team overview content will be populated here -->
            </div>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="loading-spinner">
    <i class="fas fa-spinner fa-spin fa-3x mb-3"></i>
    <h4>Loading dashboard data...</h4>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global Chart.js defaults to ensure visible text colors
Chart.defaults.color = '#343a40';
Chart.defaults.scale.ticks.color = '#343a40';
Chart.defaults.plugins.legend.labels.color = '#343a40';
Chart.defaults.plugins.tooltip.titleColor = '#ffffff';
Chart.defaults.plugins.tooltip.bodyColor = '#ffffff';

// Global variables
let currentAthlete = null;

// Dashboard-specific initialization

document.addEventListener('DOMContentLoaded', function() {
    // Check for athlete_id in URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const athleteId = urlParams.get('athlete_id');
    
    if (athleteId) {
        // If athlete_id is provided, load that specific athlete directly
        currentAthlete = parseInt(athleteId);
        loadDashboard();
        // Auto-select the athlete in the dropdown when it loads
        setTimeout(() => {
            const select = document.getElementById('athleteSelect');
            if (select) {
                select.value = athleteId;
                loadAthleteData(athleteId);
            }
        }, 1000);
    } else {
        // Otherwise, check for existing athletes normally
        checkForExistingAthletes();
    }
    
    // Setup Strava connection button (check if element exists)
    const connectBtn = document.getElementById('connectStrava');
    if (connectBtn) {
        connectBtn.addEventListener('click', function() {
            connectToStrava();
        });
    }
    
    // Athlete selection change handler (check if element exists)
    const athleteSelect = document.getElementById('athleteSelect');
    if (athleteSelect) {
        athleteSelect.addEventListener('change', function() {
            const athleteId = this.value;
            if (athleteId) {
                currentAthlete = athleteId;
                loadAthleteData(athleteId);
                
                // Join athlete's room for real-time updates
                if (socket) {
                    socket.emit('join_dashboard_room', {athlete_id: athleteId});
                }
            }
        });
    }
});

// Check for existing athletes on page load
function checkForExistingAthletes() {
    console.log('Checking for existing athletes...');
    fetch('/api/athletes')
        .then(response => {
            console.log('Athletes API response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Athletes data received:', data);
            if (data && Array.isArray(data) && data.length > 0) {
                // Athletes exist, hide connect button and show dashboard
                const connectBtn = document.getElementById('connectStrava');
                if (connectBtn) {
                    connectBtn.style.display = 'none';
                }
                
                populateAthleteSelector(data);
                
                const athleteSelection = document.getElementById('athleteSelection');
                if (athleteSelection) {
                    athleteSelection.style.display = 'block';
                }
                
                // Auto-select first athlete if only one
                if (data.length === 1) {
                    const athleteSelect = document.getElementById('athleteSelect');
                    if (athleteSelect) {
                        athleteSelect.value = data[0].id;
                        currentAthlete = data[0].id;
                        loadAthleteData(data[0].id);
                    }
                }
                
                // Update welcome message
                const welcomeText = document.querySelector('.card-glassmorphism p');
                if (welcomeText) {
                    welcomeText.textContent = `Welcome back! You have ${data.length} connected athlete${data.length > 1 ? 's' : ''}.`;
                }
            } else {
                console.log('No athletes found, showing connect button');
                // No athletes, show connect button
                const connectBtn = document.getElementById('connectStrava');
                if (connectBtn) {
                    connectBtn.style.display = 'inline-block';
                }
            }
        })
        .catch(error => {
            console.error('Error checking athletes:', error);
            // On error, show connect button
            const connectBtn = document.getElementById('connectStrava');
            if (connectBtn) {
                connectBtn.style.display = 'inline-block';
            }
        });
}

// Connect to Strava
function connectToStrava() {
    fetch('/api/auth/strava/authorize')
        .then(response => response.json())
        .then(data => {
            window.location.href = data.authorization_url;
        })
        .catch(error => {
            console.error('Error connecting to Strava:', error);
            showNotification('Failed to connect to Strava', 'error');
        });
}

// Load main dashboard
function loadDashboard() {
    document.getElementById('loadingSpinner').style.display = 'block';
    
    // Load athletes
    fetch('/api/athletes')
        .then(response => response.json())
        .then(data => {
            populateAthleteSelector(data);
            document.getElementById('athleteSelection').style.display = 'block';
            document.getElementById('loadingSpinner').style.display = 'none';
            
            // If only one athlete, auto-select
            if (data && data.length === 1) {
                document.getElementById('athleteSelect').value = data[0].id;
                currentAthlete = data[0].id;
                loadAthleteData(data[0].id);
            }
        })
        .catch(error => {
            console.error('Error loading athletes:', error);
            document.getElementById('loadingSpinner').style.display = 'none';
            showNotification('Failed to load athletes', 'error');
        });
}

// Populate athlete selector
function populateAthleteSelector(athletes) {
    console.log('Populating athlete selector with:', athletes);
    const select = document.getElementById('athleteSelect');
    
    if (!select) {
        console.error('Athlete select element not found');
        return;
    }
    
    select.innerHTML = '<option value="">Select an athlete...</option>';
    
    if (athletes && Array.isArray(athletes) && athletes.length > 0) {
        athletes.forEach(athlete => {
            console.log('Adding athlete:', athlete);
            const option = document.createElement('option');
            option.value = athlete.id;
            option.textContent = athlete.name || `Athlete ${athlete.id}`;
            select.appendChild(option);
        });
        
        const athleteCountElement = document.getElementById('athleteCount');
        if (athleteCountElement) {
            athleteCountElement.textContent = athletes.length;
        }
        
        // Show team section if multiple athletes
        if (athletes.length > 1) {
            loadTeamOverview();
        }
        
        console.log('Athlete selector populated successfully');
    } else {
        console.log('No valid athletes data to populate');
    }
}

// Load athlete-specific data
function loadAthleteData(athleteId) {
    const loadingSpinner = document.getElementById('loadingSpinner');
    if (loadingSpinner) {
        loadingSpinner.style.display = 'block';
    }
    
    // Load athlete dashboard data
    fetch(`/api/athletes/${athleteId}/dashboard-data`)
        .then(response => {
            console.log('Dashboard response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Dashboard data received:', data);
            if (data) {
                updateDashboardMetrics(data);
                updateCharts(data);
                loadRecentActivities(athleteId);
                loadRacePredictions(athleteId);
                
                // Show dashboard sections
                const metricsSection = document.getElementById('metricsSection');
                const chartsSection = document.getElementById('chartsSection');
                const activitiesSection = document.getElementById('activitiesSection');
                
                if (metricsSection) metricsSection.style.display = 'flex';
                if (chartsSection) chartsSection.style.display = 'flex';
                if (activitiesSection) activitiesSection.style.display = 'flex';
            }
            
            const loadingSpinner = document.getElementById('loadingSpinner');
            if (loadingSpinner) {
                loadingSpinner.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error loading athlete data:', error);
            const loadingSpinner = document.getElementById('loadingSpinner');
            if (loadingSpinner) {
                loadingSpinner.style.display = 'none';
            }
            showNotification('Failed to load athlete data', 'error');
        });
}

// Update dashboard metrics
function updateDashboardMetrics(data) {
    console.log('Updating dashboard metrics with data:', data);
    
    // Use the metrics object from the backend response
    const metrics = data.metrics || {};
    
    // Update metric values using the actual backend response structure
    const distanceEl = document.getElementById('metric-total_distance');
    if (distanceEl) {
        distanceEl.textContent = (metrics.total_distance || 0).toFixed(1);
    }
    
    const activitiesEl = document.getElementById('metric-total_activities');
    if (activitiesEl) {
        activitiesEl.textContent = metrics.total_activities || 0;
    }
    
    const paceEl = document.getElementById('metric-avg_pace');
    if (paceEl) {
        paceEl.textContent = metrics.avg_pace ? metrics.avg_pace.toFixed(2) + ' min/km' : 'N/A';
    }
    
    const loadEl = document.getElementById('metric-training_load');
    if (loadEl) {
        loadEl.textContent = (metrics.training_load || 0).toFixed(1);
    }
}

// Update charts with new data
function updateCharts(data) {
    // Create weekly progress chart from recent activities
    if (data.recent_activities && data.recent_activities.length > 0) {
        createWeeklyProgressChartFromActivities(data.recent_activities, data);
    }
    
    // Create status chart from metrics
    createStatusChartFromMetrics(data.metrics);
}

// Create weekly progress chart from actual activities
function createWeeklyProgressChartFromActivities(activities, athleteData) {
    const ctx = document.getElementById('weeklyProgressChart').getContext('2d');
    
    if (charts.weeklyProgress) {
        charts.weeklyProgress.destroy();
    }
    
    // Process activities into daily data
    const dailyData = {};
    activities.forEach(activity => {
        const date = new Date(activity.start_date).toISOString().split('T')[0];
        if (!dailyData[date]) {
            dailyData[date] = { distance: 0, heartRates: [], activities: 0 };
        }
        dailyData[date].distance += activity.distance || 0;
        dailyData[date].activities += 1;
        if (activity.average_heartrate) {
            dailyData[date].heartRates.push(activity.average_heartrate);
        }
    });
    
    // Create arrays for chart
    const dates = Object.keys(dailyData).sort().slice(-7); // Last 7 days
    const distances = dates.map(date => parseFloat((dailyData[date]?.distance || 0).toFixed(1)));
    const avgHeartRates = dates.map(date => {
        const hrs = dailyData[date]?.heartRates || [];
        return hrs.length > 0 ? Math.round(hrs.reduce((a, b) => a + b, 0) / hrs.length) : 0;
    });
    const labels = dates.map(date => new Date(date).toLocaleDateString('en-US', { weekday: 'short' }));
    
    charts.weeklyProgress = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Distance (km)',
                data: distances,
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: 'Avg Heart Rate (bpm)',
                data: avgHeartRates,
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                tension: 0.4,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: '#343a40'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                    titleColor: 'white',
                    bodyColor: 'white',
                    borderColor: '#007bff',
                    borderWidth: 2,
                    cornerRadius: 8,
                    displayColors: true,
                    callbacks: {
                        afterBody: function(context) {
                            const dataIndex = context[0].dataIndex;
                            const distance = distances[dataIndex];
                            const heartRate = avgHeartRates[dataIndex];
                            
                            if (distance > 0 && heartRate > 0) {
                                // Store context for async AI call
                                window.currentTooltipContext = { distance, heartRate, dataIndex };
                                
                                // Trigger AI recommendations loading
                                setTimeout(() => loadAIRecommendationsForTooltip(), 100);
                                
                                // Check if we already have cached AI recommendations
                                if (window.aiRecommendations && window.aiRecommendations.length > 0) {
                                    return [
                                        '',
                                        'ðŸ¤– AI Race Recommendations:',
                                        ...window.aiRecommendations
                                    ];
                                } else {
                                    return [
                                        '',
                                        'ðŸ¤– AI Race Recommendations:',
                                        'Loading AI insights...'
                                    ];
                                }
                            }
                            return '';
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        color: '#343a40'
                    },
                    grid: {
                        color: 'rgba(52, 58, 64, 0.2)'
                    }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    ticks: {
                        color: '#343a40'
                    },
                    grid: {
                        color: 'rgba(52, 58, 64, 0.2)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    ticks: {
                        color: '#343a40'
                    },
                    grid: {
                        drawOnChartArea: false,
                    }
                }
            }
        }
    });
}

// Create status chart from metrics - showing training intensity distribution
function createStatusChartFromMetrics(metrics) {
    const ctx = document.getElementById('statusChart').getContext('2d');
    
    if (charts.status) {
        charts.status.destroy();
    }
    
    // Calculate training metrics based on actual data
    const totalDistance = metrics.total_distance || 0;
    const avgHeartRate = metrics.avg_heart_rate || 0;
    const avgPace = metrics.avg_pace || 0;
    const totalActivities = metrics.total_activities || 0;
    
    // Heart rate zone distribution (assuming max HR ~185-190 for typical runner)
    const maxHR = 185;
    let easyZone = 0;      // <70% max HR
    let moderateZone = 0;  // 70-80% max HR  
    let hardZone = 0;      // 80-90% max HR
    let veryHardZone = 0;  // >90% max HR
    
    if (avgHeartRate > 0) {
        const hrPercent = (avgHeartRate / maxHR) * 100;
        if (hrPercent < 70) {
            easyZone = totalActivities * 0.6;
            moderateZone = totalActivities * 0.3;
            hardZone = totalActivities * 0.1;
        } else if (hrPercent < 80) {
            easyZone = totalActivities * 0.4;
            moderateZone = totalActivities * 0.4;
            hardZone = totalActivities * 0.2;
        } else {
            easyZone = totalActivities * 0.2;
            moderateZone = totalActivities * 0.3;
            hardZone = totalActivities * 0.3;
            veryHardZone = totalActivities * 0.2;
        }
    } else {
        // Fallback distribution
        easyZone = totalActivities * 0.5;
        moderateZone = totalActivities * 0.3;
        hardZone = totalActivities * 0.2;
    }
    
    charts.status = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Easy Zone (<70% HR)', 'Moderate Zone (70-80%)', 'Hard Zone (80-90%)', 'Very Hard (>90%)'],
            datasets: [{
                data: [Math.round(easyZone), Math.round(moderateZone), Math.round(hardZone), Math.round(veryHardZone)],
                backgroundColor: [
                    '#28a745',  // Easy - Green
                    '#ffc107',  // Moderate - Amber
                    '#007bff',  // Hard - Blue
                    '#343a40'   // Very Hard - Charcoal
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#343a40',
                        padding: 15,
                        font: {
                            size: 11
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? Math.round((context.parsed / total) * 100) : 0;
                            return `${context.label}: ${context.parsed} activities (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

// AI-powered race recommendation function
function generateRaceRecommendation(distance, heartRate, athleteData) {
    return new Promise((resolve, reject) => {
        // Prepare current activity data
        const currentActivity = {
            distance: distance,
            heart_rate: heartRate,
            pace: athleteData.metrics?.avg_pace || 7.0
        };
        
        // Get athlete ID from current athlete
        const selectedAthleteId = currentAthlete;
        
        if (!selectedAthleteId) {
            // Fallback to rule-based recommendations
            resolve(generateFallbackRecommendations(distance, heartRate, athleteData));
            return;
        }
        
        // Call AI recommendations API
        fetch(`/api/athletes/${selectedAthleteId}/ai-race-recommendations`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(currentActivity)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.recommendations && data.recommendations.length > 0) {
                resolve(data.recommendations);
            } else {
                resolve(generateFallbackRecommendations(distance, heartRate, athleteData));
            }
        })
        .catch(error => {
            console.warn('AI recommendations failed, using fallback:', error);
            resolve(generateFallbackRecommendations(distance, heartRate, athleteData));
        });
    });
}

// Fallback rule-based recommendations
function generateFallbackRecommendations(distance, heartRate, athleteData) {
    const metrics = athleteData.metrics || {};
    const avgPace = metrics.avg_pace || 7.0;
    const totalDistance = metrics.total_distance || 0;
    
    let recommendations = [];
    
    // Basic race distance recommendations
    const weeklyAvg = totalDistance / 4;
    if (weeklyAvg >= 40 && avgPace <= 6.0) {
        recommendations.push('ðŸ† Marathon ready - excellent fitness base');
    } else if (weeklyAvg >= 25 && avgPace <= 7.0) {
        recommendations.push('ðŸƒâ€â™‚ï¸ Half Marathon optimal distance');
    } else if (weeklyAvg >= 15) {
        recommendations.push('ðŸŽ¯ 10K race ready');
    } else {
        recommendations.push('âš¡ 5K focus recommended');
    }
    
    // Heart rate analysis
    const maxHR = 185; // Estimated
    if (heartRate < maxHR * 0.7) {
        recommendations.push('ðŸ’š Excellent aerobic efficiency');
    } else if (heartRate < maxHR * 0.85) {
        recommendations.push('ðŸŸ¡ Good training intensity');
    } else {
        recommendations.push('ðŸ”´ High intensity - ensure recovery');
    }
    
    // Simple time predictions
    const predicted5K = Math.floor(avgPace * 5);
    const predicted10K = Math.floor(avgPace * 10 * 1.05);
    recommendations.push(`ðŸŽ¯ Est. 5K: ${Math.floor(predicted5K / 60)}:${String(predicted5K % 60).padStart(2, '0')}`);
    recommendations.push(`ðŸŽ¯ Est. 10K: ${Math.floor(predicted10K / 60)}:${String(predicted10K % 60).padStart(2, '0')}`);
    
    return recommendations;
}

// Function to load AI recommendations asynchronously after tooltip display
async function loadAIRecommendationsForTooltip() {
    if (!window.currentTooltipContext || !currentDashboardData) return;
    
    const { distance, heartRate } = window.currentTooltipContext;
    
    try {
        const recommendations = await generateRaceRecommendation(distance, heartRate, currentDashboardData);
        
        // Store recommendations globally for use in tooltips
        window.aiRecommendations = recommendations;
        
        // Force chart tooltip refresh if active
        if (window.performanceChart && window.performanceChart.tooltip && window.performanceChart.tooltip._active && window.performanceChart.tooltip._active.length > 0) {
            const activePoints = window.performanceChart.tooltip._active;
            window.performanceChart.tooltip.setActiveElements(activePoints, {x: 0, y: 0});
            window.performanceChart.update('none');
        }
    } catch (error) {
        console.warn('Failed to load AI recommendations:', error);
    }
}

// Create weekly progress chart (legacy function)
function createWeeklyProgressChart(weeklyData) {
    const ctx = document.getElementById('weeklyProgressChart').getContext('2d');
    
    if (charts.weeklyProgress) {
        charts.weeklyProgress.destroy();
    }
    
    charts.weeklyProgress = new Chart(ctx, {
        type: 'line',
        data: {
            labels: weeklyData.labels || [],
            datasets: [{
                label: 'Distance (km)',
                data: weeklyData.distance || [],
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: 'Training Load',
                data: weeklyData.training_load || [],
                borderColor: '#e74c3c',
                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                tension: 0.4,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: '#343a40'
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        color: '#343a40'
                    },
                    grid: {
                        color: 'rgba(52, 58, 64, 0.2)'
                    }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    ticks: {
                        color: '#343a40'
                    },
                    grid: {
                        color: 'rgba(52, 58, 64, 0.2)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    ticks: {
                        color: '#343a40'
                    },
                    grid: {
                        drawOnChartArea: false,
                    }
                }
            }
        }
    });
}

// Create status distribution chart
function createStatusChart(statusData) {
    const ctx = document.getElementById('statusChart').getContext('2d');
    
    if (charts.status) {
        charts.status.destroy();
    }
    
    charts.status = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: statusData.labels || [],
            datasets: [{
                data: statusData.values || [],
                backgroundColor: [
                    '#27ae60',  // On Track
                    '#f39c12',  // Under-performed
                    '#e74c3c',  // Missed
                    '#95a5a6'   // Rest Day
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#343a40',
                        padding: 20
                    }
                }
            }
        }
    });
}

// Load recent activities with table format
function loadRecentActivities(athleteId) {
    fetch(`/api/athletes/${athleteId}/dashboard-data`)
        .then(response => response.json())
        .then(data => {
            const activitiesContainer = document.getElementById('recentActivities');
            if (data.recent_activities && data.recent_activities.length > 0) {
                let tableHtml = `
                    <div class="table-responsive">
                        <table class="activities-table" style="background-color: rgba(33, 37, 41, 0.95); border-radius: 8px; border: 2px solid rgba(255, 255, 255, 0.3); width: 100%;">
                            <thead style="background-color: rgba(0, 123, 255, 0.9);">
                                <tr>
                                    <th style="color: #ffffff !important; border: 1px solid rgba(255, 255, 255, 0.4); font-weight: 700; padding: 12px; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">Date</th>
                                    <th style="color: #ffffff !important; border: 1px solid rgba(255, 255, 255, 0.4); font-weight: 700; padding: 12px; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">Type</th>
                                    <th style="color: #ffffff !important; border: 1px solid rgba(255, 255, 255, 0.4); font-weight: 700; padding: 12px; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">Distance</th>
                                    <th style="color: #ffffff !important; border: 1px solid rgba(255, 255, 255, 0.4); font-weight: 700; padding: 12px; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">Duration</th>
                                    <th style="color: #ffffff !important; border: 1px solid rgba(255, 255, 255, 0.4); font-weight: 700; padding: 12px; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">Pace</th>
                                    <th style="color: #ffffff !important; border: 1px solid rgba(255, 255, 255, 0.4); font-weight: 700; padding: 12px; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">Avg HR</th>
                                    <th style="color: #ffffff !important; border: 1px solid rgba(255, 255, 255, 0.4); font-weight: 700; padding: 12px; text-shadow: 1px 1px 2px rgba(0,0,0,0.8);">Training Load</th>
                                </tr>
                            </thead>
                            <tbody style="background-color: rgba(33, 37, 41, 0.8);">
                `;
                
                data.recent_activities.slice(0, 10).forEach(activity => {
                    const date = new Date(activity.start_date).toLocaleDateString();
                    const distance = activity.distance ? (activity.distance / 1000).toFixed(2) : '0.00';
                    const time = activity.moving_time ? Math.floor(activity.moving_time / 60) : 0;
                    const hr = activity.average_heartrate ? Math.round(activity.average_heartrate) : '';
                    const pace = activity.moving_time && activity.distance ? 
                        ((activity.moving_time / 60) / (activity.distance / 1000)).toFixed(2) : '';
                    
                    // Calculate training load using TRIMP method
                    let trainingLoad = '';
                    if (activity.moving_time && activity.average_heartrate) {
                        const duration = activity.moving_time / 60; // minutes
                        const hrReserveFactor = Math.max(0, (activity.average_heartrate - 60) / 140); // Simplified HR reserve
                        trainingLoad = (duration * hrReserveFactor * 1.92).toFixed(1);
                    }
                    
                    tableHtml += `
                        <tr style="background-color: rgba(52, 58, 64, 0.6); border: 1px solid rgba(255, 255, 255, 0.2);">
                            <td style="color: #ffffff !important; border: 1px solid rgba(255, 255, 255, 0.3); font-weight: 600; padding: 10px; text-shadow: 1px 1px 2px rgba(0,0,0,0.7);">${date}</td>
                            <td style="color: #ffffff !important; border: 1px solid rgba(255, 255, 255, 0.3); font-weight: 600; padding: 10px; text-shadow: 1px 1px 2px rgba(0,0,0,0.7);">${activity.sport_type || 'Run'}</td>
                            <td style="color: #ffffff !important; border: 1px solid rgba(255, 255, 255, 0.3); font-weight: 600; padding: 10px; text-shadow: 1px 1px 2px rgba(0,0,0,0.7);">${distance} km</td>
                            <td style="color: #ffffff !important; border: 1px solid rgba(255, 255, 255, 0.3); font-weight: 600; padding: 10px; text-shadow: 1px 1px 2px rgba(0,0,0,0.7);">${time}m</td>
                            <td style="color: #ffffff !important; border: 1px solid rgba(255, 255, 255, 0.3); font-weight: 600; padding: 10px; text-shadow: 1px 1px 2px rgba(0,0,0,0.7);">${pace ? pace + ' min/km' : ''}</td>
                            <td style="color: #ffffff !important; border: 1px solid rgba(255, 255, 255, 0.3); font-weight: 600; padding: 10px; text-shadow: 1px 1px 2px rgba(0,0,0,0.7);">${hr}</td>
                            <td style="color: #ffffff !important; border: 1px solid rgba(255, 255, 255, 0.3); font-weight: 600; padding: 10px; text-shadow: 1px 1px 2px rgba(0,0,0,0.7);">${trainingLoad}</td>
                        </tr>
                    `;
                });
                
                tableHtml += `
                            </tbody>
                        </table>
                    </div>
                `;
                activitiesContainer.innerHTML = tableHtml;
                
                // Force table styling with JavaScript
                const table = activitiesContainer.querySelector('table');
                if (table) {
                    table.classList.add('js-table-fixed');
                    // Apply inline styles as backup
                    table.style.cssText = 'background-color: rgba(33, 37, 41, 0.95) !important; border-radius: 8px !important; border: 2px solid rgba(0, 123, 255, 0.6) !important; overflow: hidden !important;';
                    
                    // Style headers
                    const headers = table.querySelectorAll('th');
                    headers.forEach(th => {
                        th.style.cssText = 'background: linear-gradient(135deg, rgba(0, 123, 255, 0.9) 0%, rgba(0, 86, 179, 0.9) 100%) !important; color: #ffffff !important; font-weight: 700 !important; text-shadow: 2px 2px 4px rgba(0,0,0,0.8) !important; border: 1px solid rgba(255, 255, 255, 0.4) !important; padding: 12px 15px !important; font-size: 14px !important;';
                    });
                    
                    // Style cells
                    const cells = table.querySelectorAll('td');
                    cells.forEach(td => {
                        td.style.cssText = 'background-color: rgba(52, 58, 64, 0.9) !important; color: #ffffff !important; font-weight: 600 !important; text-shadow: 2px 2px 4px rgba(0,0,0,0.7) !important; border: 1px solid rgba(255, 255, 255, 0.3) !important; padding: 10px 15px !important; font-size: 14px !important;';
                    });
                }
            } else {
                activitiesContainer.innerHTML = `
                    <div class="text-center text-white-50 p-4">
                        <i class="fas fa-running fa-2x mb-2"></i>
                        <p>No recent activities found</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading recent activities:', error);
            const activitiesContainer = document.getElementById('recentActivities');
            activitiesContainer.innerHTML = `
                <div class="text-center text-white-50 p-4">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <p>Error loading activities</p>
                </div>
            `;
        });
}

// Load AI insights
function loadAIInsights(athleteId) {
    const insightsContainer = document.getElementById('aiInsights');
    insightsContainer.innerHTML = `
        <div class="mb-3">
            <h6 class="text-white">
                <i class="fas fa-chart-line me-2"></i>
                Performance Analysis
            </h6>
            <p class="text-white-50 small">
                Your training consistency has improved by 15% this week. Consider adding one more recovery run.
            </p>
        </div>
        <div class="mb-3">
            <h6 class="text-white">
                <i class="fas fa-bullseye me-2"></i>
                Recommendations
            </h6>
            <p class="text-white-50 small">
                Focus on maintaining your current pace for long runs. Your heart rate suggests good aerobic fitness.
            </p>
        </div>
        <div>
            <h6 class="text-white">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Alerts
            </h6>
            <p class="text-white-50 small">
                No training alerts at this time. Keep up the great work!
            </p>
        </div>
    `;
}

// Load team overview
function loadTeamOverview() {
    fetch('/api/realtime/dashboard')
        .then(response => response.json())
        .then(data => {
            document.getElementById('teamSection').style.display = 'block';
            // Populate team overview data
        })
        .catch(error => {
            console.error('Error loading team overview:', error);
        });
}

// Sync athlete data with Strava
function syncAthleteData() {
    if (!currentAthlete) {
        showNotification('Please select an athlete first', 'error');
        return;
    }
    
    const syncButton = document.getElementById('syncButton');
    const originalText = syncButton.innerHTML;
    syncButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing...';
    syncButton.disabled = true;
    
    fetch(`/api/athletes/${currentAthlete}/sync-activities`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        showNotification(`Successfully synced ${data.activities_synced} activities`, 'success');
        // Reload athlete data after sync
        loadAthleteData(currentAthlete);
    })
    .catch(error => {
        console.error('Error syncing data:', error);
        showNotification('Failed to sync Strava data', 'error');
    })
    .finally(() => {
        syncButton.innerHTML = originalText;
        syncButton.disabled = false;
    });
}

// Load race predictions for the selected athlete
function loadRacePredictions(athleteId) {
    const container = document.getElementById('racePredictions');
    
    // Show loading state
    container.innerHTML = `
        <div class="text-center text-white-50 p-4">
            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
            <p>Loading race predictions...</p>
        </div>
    `;
    
    // Common race distances to predict
    const raceDistances = ['5K', '10K', 'Half Marathon', 'Marathon'];
    const predictions = [];
    
    // Fetch predictions for each distance
    Promise.all(raceDistances.map(distance => 
        fetch(`/api/athletes/${athleteId}/race-prediction?distance=${encodeURIComponent(distance)}`)
            .then(response => response.json())
            .then(data => ({ distance, ...data }))
            .catch(error => ({ distance, error: true }))
    ))
    .then(results => {
        // Filter successful predictions
        const validPredictions = results.filter(p => !p.error);
        
        if (validPredictions.length === 0) {
            container.innerHTML = `
                <div class="text-center text-white-50 p-4">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <p>Unable to generate race predictions</p>
                </div>
            `;
            return;
        }
        
        // Create prediction cards
        container.innerHTML = `
            <div class="prediction-grid">
                ${validPredictions.map(prediction => `
                    <div class="prediction-card">
                        <div class="prediction-header">
                            <h5 class="prediction-title">${prediction.race_distance}</h5>
                            <span class="confidence-badge">${prediction.confidence_score}% confidence</span>
                        </div>
                        <div class="prediction-time">${prediction.predicted_time_formatted}</div>
                        <div class="prediction-pace">
                            ${formatPaceFromSeconds(prediction.predicted_time_seconds, getRaceDistanceKm(prediction.race_distance))}
                        </div>
                    </div>
                `).join('')}
            </div>
            <div class="text-center mt-3">
                <a href="/race-optimizer" class="btn btn-outline-light btn-sm">
                    <i class="fas fa-chart-line me-2"></i>
                    View Detailed Analysis
                </a>
            </div>
        `;
    })
    .catch(error => {
        console.error('Error loading race predictions:', error);
        container.innerHTML = `
            <div class="text-center text-white-50 p-4">
                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                <p>Failed to load race predictions</p>
            </div>
        `;
    });
}

// Helper function to format pace from total seconds and distance
function formatPaceFromSeconds(totalSeconds, distanceKm) {
    const paceSeconds = totalSeconds / distanceKm;
    const minutes = Math.floor(paceSeconds / 60);
    const seconds = Math.floor(paceSeconds % 60);
    return `${minutes}:${seconds.toString().padStart(2, '0')}/km avg pace`;
}

// Helper function to get race distance in kilometers
function getRaceDistanceKm(raceDistance) {
    const distances = {
        '5K': 5.0,
        '10K': 10.0,
        'Half Marathon': 21.0975,
        'Marathon': 42.195
    };
    return distances[raceDistance] || 10.0;
}

// Load dashboard data on page load
document.addEventListener('DOMContentLoaded', function() {
    // Show athlete selection first
    document.getElementById('athleteSelection').style.display = 'block';
    
    // Load athletes
    checkForExistingAthletes();
    
    // Initialize with first athlete if athlete_id is provided
    const urlParams = new URLSearchParams(window.location.search);
    const athleteId = urlParams.get('athlete_id');
    if (athleteId) {
        // Wait a bit for athletes to load, then select
        setTimeout(() => {
            const select = document.getElementById('athleteSelect');
            if (select && select.options.length > 0) {
                select.value = athleteId;
                loadAthleteData(athleteId);
            }
        }, 1000);
    } else {
        // Auto-load first athlete if available
        setTimeout(() => {
            const select = document.getElementById('athleteSelect');
            if (select && select.options.length > 1) {
                const firstAthleteId = select.options[1].value; // Skip the "loading" option
                select.value = firstAthleteId;
                loadAthleteData(firstAthleteId);
            }
        }, 1000);
    }
});
</script>
{% endblock %}