{% extends "base.html" %}

{% block title %}Individual Analytics{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        Individual Analytics
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="athleteSelect" class="form-label">Select Athlete:</label>
                            <select id="athleteSelect" class="form-select" onchange="loadAnalytics()">
                                <option value="">Choose an athlete...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="timePeriod" class="form-label">Time Period:</label>
                            <select id="timePeriod" class="form-select" onchange="loadAnalytics()">
                                <option value="7">Last 7 days</option>
                                <option value="14">Last 14 days</option>
                                <option value="30" selected>Last 30 days</option>
                                <option value="90">Last 90 days</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics Content -->
    <div id="analyticsContent" style="display: none;">
        <!-- Summary Stats -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-primary">Total Distance</h5>
                        <h3 id="totalDistance">--</h3>
                        <p class="text-muted">kilometers</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-success">Total Time</h5>
                        <h3 id="totalTime">--</h3>
                        <p class="text-muted">hours</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-warning">Average Pace</h5>
                        <h3 id="avgPace">--</h3>
                        <p class="text-muted">min/km</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-danger">Avg Heart Rate</h5>
                        <h3 id="avgHeartRate">--</h3>
                        <p class="text-muted">bpm</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Training Volume</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="volumeChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Pace Analysis</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="paceChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Heart Rate Zones</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="heartRateChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Training Load</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="trainingLoadChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loadingState" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3">Loading analytics data...</p>
    </div>

    <!-- No Data State -->
    <div id="noDataState" class="text-center py-5" style="display: none;">
        <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
        <h5>No Analytics Data</h5>
        <p class="text-muted">Select an athlete to view their performance analytics.</p>
    </div>
</div>

<script>
let charts = {};
let currentAthleteId = null;

// Load athletes on page load
document.addEventListener('DOMContentLoaded', function() {
    loadAthletes();
});

function loadAthletes() {
    fetch('/api/athletes')
        .then(response => response.json())
        .then(athletes => {
            const select = document.getElementById('athleteSelect');
            select.innerHTML = '<option value="">Choose an athlete...</option>';
            
            athletes.forEach(athlete => {
                const option = document.createElement('option');
                option.value = athlete.id;
                option.textContent = athlete.name;
                select.appendChild(option);
            });

            // Auto-select first athlete if only one exists
            if (athletes.length === 1) {
                select.value = athletes[0].id;
                loadAnalytics();
            }
        })
        .catch(error => {
            console.error('Error loading athletes:', error);
        });
}

function loadAnalytics() {
    const athleteId = document.getElementById('athleteSelect').value;
    const timePeriod = document.getElementById('timePeriod').value;

    if (!athleteId) {
        showNoData();
        return;
    }

    currentAthleteId = athleteId;
    showLoading();

    // Load analytics summary
    fetch(`/api/athletes/${athleteId}/summary?days=${timePeriod}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            updateSummaryStats(data);
            loadCharts(athleteId, timePeriod);
            showAnalytics();
        })
        .catch(error => {
            console.error('Error loading analytics:', error);
            showError('Failed to load analytics data');
        });
}

function updateSummaryStats(data) {
    document.getElementById('totalDistance').textContent = `${data.total_distance.toFixed(1)} km`;
    document.getElementById('totalTime').textContent = `${data.total_time.toFixed(1)} hrs`;
    document.getElementById('avgPace').textContent = data.avg_pace ? `${data.avg_pace.toFixed(2)} min/km` : '--';
    document.getElementById('avgHeartRate').textContent = data.avg_heart_rate ? `${Math.round(data.avg_heart_rate)} bpm` : '--';
}

function loadCharts(athleteId, timePeriod) {
    // Destroy existing charts
    Object.values(charts).forEach(chart => chart.destroy());
    charts = {};

    // Load volume chart
    fetch(`/api/athletes/${athleteId}/volume-trend?days=${timePeriod}`)
        .then(response => response.json())
        .then(data => {
            if (data.dates && data.distances) {
                createVolumeChart(data);
            }
        })
        .catch(error => console.error('Volume chart error:', error));

    // Load pace chart
    fetch(`/api/athletes/${athleteId}/pace-analysis?days=${timePeriod}`)
        .then(response => response.json())
        .then(data => {
            if (data.dates && data.average_paces) {
                createPaceChart(data);
            }
        })
        .catch(error => console.error('Pace chart error:', error));

    // Load heart rate zones chart
    fetch(`/api/athletes/${athleteId}/heart-rate-zones?days=${timePeriod}`)
        .then(response => response.json())
        .then(data => {
            if (data.zones && data.percentages) {
                createHeartRateChart(data);
            }
        })
        .catch(error => console.error('Heart rate chart error:', error));

    // Load training load chart
    fetch(`/api/athletes/${athleteId}/training-load?days=${timePeriod}`)
        .then(response => response.json())
        .then(data => {
            if (data.dates && data.training_loads) {
                createTrainingLoadChart(data);
            }
        })
        .catch(error => console.error('Training load chart error:', error));
}

function createVolumeChart(data) {
    const ctx = document.getElementById('volumeChart').getContext('2d');
    charts.volume = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.dates,
            datasets: [{
                label: 'Distance (km)',
                data: data.distances,
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.1,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function createPaceChart(data) {
    const ctx = document.getElementById('paceChart').getContext('2d');
    charts.pace = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.dates,
            datasets: [{
                label: 'Average Pace (min/km)',
                data: data.average_paces,
                backgroundColor: '#28a745',
                borderColor: '#1e7e34',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function createHeartRateChart(data) {
    const ctx = document.getElementById('heartRateChart').getContext('2d');
    charts.heartRate = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: data.zones,
            datasets: [{
                data: data.percentages,
                backgroundColor: [
                    '#28a745',
                    '#ffc107',
                    '#fd7e14',
                    '#dc3545'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

function createTrainingLoadChart(data) {
    const ctx = document.getElementById('trainingLoadChart').getContext('2d');
    charts.trainingLoad = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.dates,
            datasets: [{
                label: 'Training Load',
                data: data.training_loads,
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.1,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function showLoading() {
    document.getElementById('loadingState').style.display = 'block';
    document.getElementById('analyticsContent').style.display = 'none';
    document.getElementById('noDataState').style.display = 'none';
}

function showAnalytics() {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('analyticsContent').style.display = 'block';
    document.getElementById('noDataState').style.display = 'none';
}

function showNoData() {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('analyticsContent').style.display = 'none';
    document.getElementById('noDataState').style.display = 'block';
}

function showError(message) {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('analyticsContent').style.display = 'none';
    document.getElementById('noDataState').style.display = 'block';
    document.querySelector('#noDataState h5').textContent = 'Error Loading Data';
    document.querySelector('#noDataState p').textContent = message;
}
</script>
{% endblock %}