{% extends "base.html" %}

{% block title %}Individual Analytics - Marathon Training Dashboard{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card card-glassmorphism">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="text-white mb-2">
                                <i class="fas fa-chart-line me-2"></i>
                                Individual Analytics
                            </h1>
                            <p class="text-white-75 mb-0">
                                Comprehensive performance analysis and insights for individual athletes
                            </p>
                        </div>
                        <div>
                            <a href="/" class="btn btn-outline-light">
                                <i class="fas fa-arrow-left me-2"></i>
                                Back to Community
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Athlete Selection -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card card-glassmorphism">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <label for="athleteSelect" class="form-label text-white fw-bold">Select Athlete:</label>
                            <select class="form-select" id="athleteSelect" onchange="loadAthleteAnalytics()">
                                <option value="">Loading athletes...</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="timePeriodSelect" class="form-label text-white fw-bold">Time Period:</label>
                            <select class="form-select" id="timePeriodSelect" onchange="loadAthleteAnalytics()">
                                <option value="7">Last 7 days</option>
                                <option value="30" selected>Last 30 days</option>
                                <option value="90">Last 90 days</option>
                                <option value="365">Last year</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex gap-2 mt-4">
                                <button class="btn btn-primary" onclick="loadAthleteAnalytics()">
                                    <i class="fas fa-sync-alt me-2"></i>
                                    Refresh Data
                                </button>
                                <button class="btn btn-success" onclick="exportData()">
                                    <i class="fas fa-download me-2"></i>
                                    Export
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div class="row mb-4" id="loadingState" style="display: none;">
        <div class="col-12">
            <div class="card card-glassmorphism">
                <div class="card-body text-center">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5 class="text-white">Loading Analytics Data...</h5>
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics Content -->
    <div id="analyticsContent" style="display: none;">
        
        <!-- Performance Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card card-glassmorphism h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-route text-primary fs-1 mb-3"></i>
                        <h5 class="text-white">Total Distance</h5>
                        <h2 class="text-primary mb-0" id="totalDistance">--</h2>
                        <small class="text-white-75" id="distanceChange">--</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-glassmorphism h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-clock text-warning fs-1 mb-3"></i>
                        <h5 class="text-white">Training Time</h5>
                        <h2 class="text-warning mb-0" id="totalTime">--</h2>
                        <small class="text-white-75" id="timeChange">--</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-glassmorphism h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-tachometer-alt text-success fs-1 mb-3"></i>
                        <h5 class="text-white">Avg Pace</h5>
                        <h2 class="text-success mb-0" id="avgPace">--</h2>
                        <small class="text-white-75" id="paceChange">--</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card card-glassmorphism h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-heartbeat text-danger fs-1 mb-3"></i>
                        <h5 class="text-white">Avg Heart Rate</h5>
                        <h2 class="text-danger mb-0" id="avgHeartRate">--</h2>
                        <small class="text-white-75" id="hrChange">--</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="row mb-4">
            <!-- Training Volume Chart -->
            <div class="col-md-6">
                <div class="card card-glassmorphism">
                    <div class="card-header">
                        <h5 class="text-white mb-0">
                            <i class="fas fa-chart-bar me-2"></i>
                            Training Volume Trend
                        </h5>
                    </div>
                    <div class="card-body">
                        <canvas id="volumeChart" height="300"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Pace Analysis Chart -->
            <div class="col-md-6">
                <div class="card card-glassmorphism">
                    <div class="card-header">
                        <h5 class="text-white mb-0">
                            <i class="fas fa-running me-2"></i>
                            Pace Analysis
                        </h5>
                    </div>
                    <div class="card-body">
                        <canvas id="paceChart" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <!-- Heart Rate Zones -->
            <div class="col-md-6">
                <div class="card card-glassmorphism">
                    <div class="card-header">
                        <h5 class="text-white mb-0">
                            <i class="fas fa-heart me-2"></i>
                            Heart Rate Zones
                        </h5>
                    </div>
                    <div class="card-body">
                        <canvas id="heartRateChart" height="300"></canvas>
                    </div>
                </div>
            </div>

            <!-- Training Load -->
            <div class="col-md-6">
                <div class="card card-glassmorphism">
                    <div class="card-header">
                        <h5 class="text-white mb-0">
                            <i class="fas fa-weight-hanging me-2"></i>
                            Training Load
                        </h5>
                    </div>
                    <div class="card-body">
                        <canvas id="trainingLoadChart" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activities Table -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card card-glassmorphism">
                    <div class="card-header">
                        <h5 class="text-white mb-0">
                            <i class="fas fa-list me-2"></i>
                            Recent Activities
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-dark table-striped">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Type</th>
                                        <th>Distance</th>
                                        <th>Duration</th>
                                        <th>Pace</th>
                                        <th>Avg HR</th>
                                        <th>Training Load</th>
                                    </tr>
                                </thead>
                                <tbody id="activitiesTableBody">
                                    <tr>
                                        <td colspan="7" class="text-center text-white-75">Loading activities...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Insights -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card card-glassmorphism">
                    <div class="card-header">
                        <h5 class="text-white mb-0">
                            <i class="fas fa-lightbulb me-2"></i>
                            Performance Insights
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="performanceInsights">
                            <div class="text-center text-white-75">
                                <i class="fas fa-chart-line fs-1 mb-3"></i>
                                <p>Performance insights will appear here after selecting an athlete</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card card-glassmorphism">
                    <div class="card-header">
                        <h5 class="text-white mb-0">
                            <i class="fas fa-rocket me-2"></i>
                            Quick Actions
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <button class="btn btn-primary w-100 mb-2" onclick="openRacePredictor()">
                                    <i class="fas fa-trophy me-2"></i>
                                    Race Predictor
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-warning w-100 mb-2" onclick="openInjuryRisk()">
                                    <i class="fas fa-shield-alt me-2"></i>
                                    Injury Risk
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-success w-100 mb-2" onclick="openRaceOptimizer()">
                                    <i class="fas fa-magic me-2"></i>
                                    Race Optimizer
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-info w-100 mb-2" onclick="openDashboard()">
                                    <i class="fas fa-dashboard me-2"></i>
                                    Full Dashboard
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Error Display -->
    <div id="errorDisplay" style="display: none;">
        <div class="row">
            <div class="col-12">
                <div class="alert alert-danger" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="errorMessage">An error occurred while loading analytics data.</span>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let currentAthlete = null;
let charts = {};

// Load athletes and analytics on page load
document.addEventListener('DOMContentLoaded', function() {
    loadAthletes();
});

// Load athletes for selection
function loadAthletes() {
    fetch('/api/athletes')
        .then(response => response.json())
        .then(athletes => {
            const select = document.getElementById('athleteSelect');
            select.innerHTML = '<option value="">Select an athlete...</option>';
            
            if (athletes && athletes.length > 0) {
                athletes.forEach(athlete => {
                    const option = document.createElement('option');
                    option.value = athlete.id;
                    option.textContent = athlete.name;
                    select.appendChild(option);
                });
                
                // Auto-select first athlete
                if (athletes.length === 1) {
                    select.value = athletes[0].id;
                    loadAthleteAnalytics();
                }
            }
        })
        .catch(error => {
            console.error('Error loading athletes:', error);
            showError('Failed to load athletes');
        });
}

// Load analytics data for selected athlete
function loadAthleteAnalytics() {
    const athleteId = document.getElementById('athleteSelect').value;
    const timePeriod = document.getElementById('timePeriodSelect').value;
    
    if (!athleteId) {
        hideAnalytics();
        return;
    }
    
    currentAthlete = athleteId;
    showLoading();
    
    // Load athlete summary data
    fetch(`/api/athletes/${athleteId}/summary?days=${timePeriod}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showError(data.error);
            } else {
                displayAnalytics(data);
                loadCharts(athleteId, timePeriod);
                loadRecentActivities(athleteId);
                loadPerformanceInsights(athleteId);
            }
        })
        .catch(error => {
            console.error('Error loading analytics:', error);
            showError('Failed to load analytics data');
        })
        .finally(() => {
            hideLoading();
        });
}

// Display analytics summary
function displayAnalytics(data) {
    document.getElementById('totalDistance').textContent = `${data.total_distance_km} km`;
    document.getElementById('totalTime').textContent = formatDuration(data.total_moving_time);
    document.getElementById('avgPace').textContent = data.average_pace_formatted || '--';
    document.getElementById('avgHeartRate').textContent = data.average_heart_rate ? `${Math.round(data.average_heart_rate)} bpm` : '--';
    
    // Show percentage changes
    document.getElementById('distanceChange').textContent = data.distance_change || '--';
    document.getElementById('timeChange').textContent = data.time_change || '--';
    document.getElementById('paceChange').textContent = data.pace_change || '--';
    document.getElementById('hrChange').textContent = data.hr_change || '--';
    
    showAnalytics();
}

// Load and display charts
function loadCharts(athleteId, timePeriod) {
    // Training Volume Chart
    fetch(`/api/athletes/${athleteId}/volume-trend?days=${timePeriod}`)
        .then(response => response.json())
        .then(data => {
            if (data.dates && data.distances) {
                createVolumeChart(data);
            }
        })
        .catch(error => console.error('Error loading volume chart:', error));
    
    // Pace Analysis Chart
    fetch(`/api/athletes/${athleteId}/pace-analysis?days=${timePeriod}`)
        .then(response => response.json())
        .then(data => {
            if (data.dates && data.paces) {
                createPaceChart(data);
            }
        })
        .catch(error => console.error('Error loading pace chart:', error));
    
    // Heart Rate Zones
    fetch(`/api/athletes/${athleteId}/heart-rate-zones?days=${timePeriod}`)
        .then(response => response.json())
        .then(data => {
            if (data.zones) {
                createHeartRateChart(data);
            }
        })
        .catch(error => console.error('Error loading heart rate chart:', error));
    
    // Training Load
    fetch(`/api/athletes/${athleteId}/training-load?days=${timePeriod}`)
        .then(response => response.json())
        .then(data => {
            if (data.dates && data.loads) {
                createTrainingLoadChart(data);
            }
        })
        .catch(error => console.error('Error loading training load chart:', error));
}

// Create volume chart
function createVolumeChart(data) {
    const ctx = document.getElementById('volumeChart').getContext('2d');
    
    if (charts.volume) {
        charts.volume.destroy();
    }
    
    charts.volume = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.dates,
            datasets: [{
                label: 'Distance (km)',
                data: data.distances,
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: '#ffffff' }
                }
            },
            scales: {
                x: {
                    ticks: { color: '#ffffff' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                y: {
                    ticks: { color: '#ffffff' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                }
            }
        }
    });
}

// Create pace chart
function createPaceChart(data) {
    const ctx = document.getElementById('paceChart').getContext('2d');
    
    if (charts.pace) {
        charts.pace.destroy();
    }
    
    charts.pace = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.dates,
            datasets: [{
                label: 'Pace (min/km)',
                data: data.paces,
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: '#ffffff' }
                }
            },
            scales: {
                x: {
                    ticks: { color: '#ffffff' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                y: {
                    ticks: { color: '#ffffff' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                }
            }
        }
    });
}

// Create heart rate chart
function createHeartRateChart(data) {
    const ctx = document.getElementById('heartRateChart').getContext('2d');
    
    if (charts.heartRate) {
        charts.heartRate.destroy();
    }
    
    charts.heartRate = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Zone 1', 'Zone 2', 'Zone 3', 'Zone 4', 'Zone 5'],
            datasets: [{
                data: data.zones,
                backgroundColor: [
                    '#6b7280', // Zone 1 - Gray
                    '#3b82f6', // Zone 2 - Blue
                    '#10b981', // Zone 3 - Green
                    '#f59e0b', // Zone 4 - Yellow
                    '#ef4444'  // Zone 5 - Red
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: '#ffffff' }
                }
            }
        }
    });
}

// Create training load chart
function createTrainingLoadChart(data) {
    const ctx = document.getElementById('trainingLoadChart').getContext('2d');
    
    if (charts.trainingLoad) {
        charts.trainingLoad.destroy();
    }
    
    charts.trainingLoad = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.dates,
            datasets: [{
                label: 'Training Load',
                data: data.loads,
                backgroundColor: 'rgba(139, 69, 19, 0.8)',
                borderColor: '#8b4513',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: '#ffffff' }
                }
            },
            scales: {
                x: {
                    ticks: { color: '#ffffff' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                y: {
                    ticks: { color: '#ffffff' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                }
            }
        }
    });
}

// Load recent activities
function loadRecentActivities(athleteId) {
    fetch(`/api/athletes/${athleteId}/recent-activities?limit=10`)
        .then(response => response.json())
        .then(activities => {
            const tbody = document.getElementById('activitiesTableBody');
            tbody.innerHTML = '';
            
            if (activities && activities.length > 0) {
                activities.forEach(activity => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${new Date(activity.start_date).toLocaleDateString()}</td>
                        <td>${activity.sport_type}</td>
                        <td>${(activity.distance / 1000).toFixed(2)} km</td>
                        <td>${formatDuration(activity.moving_time)}</td>
                        <td>${activity.pace_formatted || '--'}</td>
                        <td>${activity.average_heartrate ? Math.round(activity.average_heartrate) + ' bpm' : '--'}</td>
                        <td>${activity.training_stress_score ? Math.round(activity.training_stress_score) : '--'}</td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-white-75">No activities found</td></tr>';
            }
        })
        .catch(error => {
            console.error('Error loading recent activities:', error);
            const tbody = document.getElementById('activitiesTableBody');
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading activities</td></tr>';
        });
}

// Load performance insights
function loadPerformanceInsights(athleteId) {
    fetch(`/api/athletes/${athleteId}/insights`)
        .then(response => response.json())
        .then(insights => {
            const container = document.getElementById('performanceInsights');
            
            if (insights && insights.length > 0) {
                container.innerHTML = insights.map(insight => `
                    <div class="alert alert-info mb-3">
                        <h6 class="text-primary">${insight.category}</h6>
                        <p class="mb-0">${insight.message}</p>
                    </div>
                `).join('');
            } else {
                container.innerHTML = `
                    <div class="text-center text-white-75">
                        <i class="fas fa-info-circle fs-1 mb-3"></i>
                        <p>No specific insights available. Continue training consistently!</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading insights:', error);
            document.getElementById('performanceInsights').innerHTML = `
                <div class="text-center text-white-75">
                    <i class="fas fa-exclamation-triangle fs-1 mb-3"></i>
                    <p>Unable to load performance insights</p>
                </div>
            `;
        });
}

// Utility functions
function formatDuration(seconds) {
    if (!seconds) return '--';
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    if (hours > 0) {
        return `${hours}h ${minutes}m`;
    }
    return `${minutes}m`;
}

function showLoading() {
    document.getElementById('loadingState').style.display = 'block';
    document.getElementById('analyticsContent').style.display = 'none';
    document.getElementById('errorDisplay').style.display = 'none';
}

function hideLoading() {
    document.getElementById('loadingState').style.display = 'none';
}

function showAnalytics() {
    document.getElementById('analyticsContent').style.display = 'block';
    document.getElementById('errorDisplay').style.display = 'none';
}

function hideAnalytics() {
    document.getElementById('analyticsContent').style.display = 'none';
}

function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorDisplay').style.display = 'block';
    document.getElementById('analyticsContent').style.display = 'none';
}

// Navigation functions
function openRacePredictor() {
    if (currentAthlete) {
        window.location.href = `/race-predictor?athlete_id=${currentAthlete}`;
    } else {
        alert('Please select an athlete first');
    }
}

function openInjuryRisk() {
    if (currentAthlete) {
        window.location.href = `/injury-risk?athlete_id=${currentAthlete}`;
    } else {
        alert('Please select an athlete first');
    }
}

function openRaceOptimizer() {
    if (currentAthlete) {
        window.location.href = `/race-optimizer?athlete_id=${currentAthlete}`;
    } else {
        alert('Please select an athlete first');
    }
}

function openDashboard() {
    if (currentAthlete) {
        window.location.href = `/dashboard?athlete_id=${currentAthlete}`;
    } else {
        alert('Please select an athlete first');
    }
}

function exportData() {
    if (currentAthlete) {
        const timePeriod = document.getElementById('timePeriodSelect').value;
        window.open(`/api/athletes/${currentAthlete}/export?days=${timePeriod}`, '_blank');
    } else {
        alert('Please select an athlete first');
    }
}
</script>
{% endblock %}