<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Dashboard - Marathon Training</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            background: linear-gradient(135deg, #065f46 0%, #0F766E 50%, #14B8A6 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .nav-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .nav-link {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        .live-indicator {
            display: inline-block;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 25px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .live-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #10B981;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .kpi-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
        }
        
        .kpi-icon {
            font-size: 2rem;
            margin-bottom: 15px;
            color: #FBBF24;
        }
        
        .kpi-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: white;
        }
        
        .kpi-label {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .kpi-detail {
            font-size: 0.85rem;
            opacity: 0.7;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .chart-container, .section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .chart-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-icon {
            font-size: 1.5rem;
        }
        
        .leaderboard-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s ease;
        }
        
        .leaderboard-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .athlete-info h4 {
            margin: 0;
            color: white;
            font-size: 1.1rem;
        }
        
        .athlete-stats {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 5px;
        }
        
        .athlete-metrics {
            text-align: right;
        }
        
        .distance {
            font-size: 1.2rem;
            font-weight: bold;
            color: #14B8A6;
        }
        
        .pace {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .activity-stream {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .activity-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid;
            transition: background 0.3s ease;
        }
        
        .activity-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .activity-item.activity {
            border-left-color: #14B8A6;
        }
        
        .activity-item.milestone {
            border-left-color: #FBBF24;
        }
        
        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .activity-name {
            font-weight: bold;
            color: white;
            font-size: 1rem;
        }
        
        .activity-time {
            font-size: 0.85rem;
            opacity: 0.7;
        }
        
        .activity-details {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .activity-athlete {
            font-size: 0.85rem;
            opacity: 0.7;
            margin-top: 5px;
        }
        
        /* Loading states */
        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            opacity: 0.7;
        }
        
        .error {
            text-align: center;
            padding: 40px;
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(255, 107, 107, 0.3);
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .kpi-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .container {
                padding: 15px;
            }
        }
        
        /* Chart containers should never have white backgrounds */
        #trainingTrendsChart, #trainingLoadChart {
            background: transparent !important;
        }
        
        svg {
            background: transparent !important;
        }
        
        /* Leaderboard styling with action buttons */
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 20px;
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .leaderboard-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            background: rgba(255, 255, 255, 0.98);
        }
        
        .rank-badge {
            width: 40px;
            height: 40px;
            background: #FFD700;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            color: #333;
            margin-right: 20px;
            flex-shrink: 0;
        }
        
        .athlete-info {
            flex: 1;
        }
        
        .athlete-name {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        
        .athlete-stats {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .dashboard-btn {
            background: #2196F3;
            color: white;
        }
        
        .dashboard-btn:hover {
            background: #1976D2;
            transform: translateY(-1px);
        }
        
        .predictor-btn {
            background: #4CAF50;
            color: white;
        }
        
        .predictor-btn:hover {
            background: #388E3C;
            transform: translateY(-1px);
        }
        
        .analyser-btn {
            background: #FF9800;
            color: white;
        }
        
        .analyser-btn:hover {
            background: #F57C00;
            transform: translateY(-1px);
        }
        
        .btn-icon {
            font-size: 12px;
        }
        
        /* Strava Connect Section Styling */
        .connect-section {
            text-align: center;
            padding: 20px 0;
        }
        
        .connect-section h3 {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: white;
        }
        
        .connect-section p {
            font-size: 1rem;
            margin-bottom: 25px;
            opacity: 0.9;
        }
        
        .connect-benefits {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .benefit {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            transition: background 0.3s ease;
        }
        
        .benefit:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .benefit-icon {
            font-size: 1.5rem;
        }
        
        .strava-connect-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            transition: transform 0.3s ease;
            margin: 20px 0;
        }
        
        .strava-connect-btn:hover {
            transform: scale(1.05);
        }
        
        .connect-note {
            font-size: 0.85rem;
            opacity: 0.7;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üèÉ‚Äç‚ôÇÔ∏è Community Training Dashboard</h1>
            <p>Real-time insights from our marathon training community</p>

            <div class="live-indicator">
                <span class="live-dot"></span>
                Live Data
            </div>
            
            <!-- Navigation Links -->
            <div class="nav-links">
                <a href="/achievements" class="nav-link">
                    üèÜ Achievement Stickers
                </a>
                <a href="/dashboard/1" class="nav-link">
                    üìä Athlete Dashboard
                </a>
                <a href="/race-predictor/1" class="nav-link">
                    üéØ Race Predictor
                </a>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-icon">üë•</div>
                <div class="kpi-value" id="totalAthletes">-</div>
                <div class="kpi-label">Active Athletes</div>
                <div class="kpi-detail">Last 30 Days</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-icon">üìè</div>
                <div class="kpi-value" id="totalDistance">-</div>
                <div class="kpi-label">Total Distance</div>
                <div class="kpi-detail">Last 30 Days</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-icon">‚ö°</div>
                <div class="kpi-value" id="avgPace">-</div>
                <div class="kpi-label">Average Pace</div>
                <div class="kpi-detail">Last 30 Days</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-icon">üèÉ</div>
                <div class="kpi-value" id="totalActivities">-</div>
                <div class="kpi-label">Total Activities</div>
                <div class="kpi-detail">Last 30 Days</div>
            </div>
        </div>

        <!-- Weekly Leaderboard -->
        <div class="section">
            <div class="chart-title">
                <span class="section-icon">üèÜ</span>
                Performance Leaderboard
                <div style="margin-left: auto;">
                    <a href="/achievements" class="nav-link" style="font-size: 0.9rem; padding: 8px 16px;">
                        üéñÔ∏è Achievement Stickers
                    </a>
                </div>
            </div>
            <div id="leaderboard" class="loading">Loading leaderboard...</div>
        </div>

        <!-- Charts Row -->
        <div class="charts-grid">
            <div class="chart-container">
                <div class="chart-title">
                    <span class="section-icon">üìä</span>
                    Community Training Trends
                </div>
                <div id="trainingTrendsChart" style="height: 300px; width: 100%;"></div>
            </div>

            <div class="chart-container">
                <div class="chart-title">
                    <span class="section-icon">üí™</span>
                    Training Load Distribution (Last 30 Days)
                </div>
                <div id="trainingLoadChart" style="height: 300px; width: 100%;"></div>
            </div>
        </div>

        <!-- Activity Stream -->
        <div class="section">
            <div class="chart-title">
                <span class="section-icon">üì±</span>
                Community Activity Stream
            </div>
            <div id="activityStream" class="activity-stream loading">Loading activities...</div>
        </div>

        <!-- Strava Connect Section -->
        <div class="section">
            <div class="chart-title">
                <span class="section-icon">üöÄ</span>
                Join Our Community
            </div>
            <div class="connect-section">
                <h3>Connect Your Strava Account</h3>
                <p>Track your progress, compete with friends, and achieve your marathon goals together!</p>
                <div class="connect-benefits">
                    <div class="benefit">
                        <span class="benefit-icon">üìä</span>
                        <span>Real-time Performance Analytics</span>
                    </div>
                    <div class="benefit">
                        <span class="benefit-icon">üèÜ</span>
                        <span>Community Leaderboards</span>
                    </div>
                    <div class="benefit">
                        <span class="benefit-icon">üéØ</span>
                        <span>AI-Powered Training Insights</span>
                    </div>
                    <div class="benefit">
                        <span class="benefit-icon">üë•</span>
                        <span>Social Training Experience</span>
                    </div>
                </div>
                <button class="strava-connect-btn" onclick="connectStrava()">
                    <img src="/attached_assets/btn_strava_connect_with_orange_x2_1749293089636.png" 
                         alt="Connect with Strava" style="height: 48px;">
                </button>
                <p class="connect-note">Secure OAuth 2.0 authentication - your data remains private</p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Community Dashboard loading...');
            loadCommunityData();
            
            // Refresh data every 30 seconds
            setInterval(loadCommunityData, 30000);
        });

        async function loadCommunityData() {
            try {
                console.log('Loading community overview...');
                const response = await fetch('/api/community/overview');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Community data loaded:', data);
                
                updateKPIs(data.kpis);
                renderLeaderboard(data.leaderboard);
                renderTrainingTrendsChart(data.communityTrends);
                renderTrainingLoadChart(data.trainingLoadDistribution);
                
                loadActivityStream();
                
            } catch (error) {
                console.error('Error loading community data:', error);
                showError('Failed to load community data. Please refresh the page.');
            }
        }

        async function loadActivityStream() {
            try {
                const response = await fetch('/api/community/activity-stream');
                const data = await response.json();
                console.log('Activity stream loaded:', data);
                renderActivityStream(data.stream);
            } catch (error) {
                console.error('Error loading activity stream:', error);
                document.getElementById('activityStream').innerHTML = '<div class="error">Failed to load activity stream</div>';
            }
        }

        function updateKPIs(kpis) {
            document.getElementById('totalAthletes').textContent = kpis.totalAthletes || 0;
            document.getElementById('totalDistance').textContent = `${(kpis.totalDistance || 0).toFixed(1)} units`;
            document.getElementById('avgPace').textContent = formatPace(kpis.avgPace || 0);
            document.getElementById('totalActivities').textContent = kpis.totalActivities || 0;
        }

        function getSportIcon(sportType) {
            const icons = {
                'Run': 'üèÉ‚Äç‚ôÇÔ∏è',
                'Tennis': 'üéæ',
                'Cycling': 'üö¥‚Äç‚ôÇÔ∏è',
                'Swimming': 'üèä‚Äç‚ôÇÔ∏è',
                'Strength': 'üí™',
                'Yoga': 'üßò‚Äç‚ôÄÔ∏è',
                'Walk': 'üö∂‚Äç‚ôÇÔ∏è',
                'Hike': 'ü•æ'
            };
            return icons[sportType] || 'üèÉ‚Äç‚ôÇÔ∏è';
        }

        function renderLeaderboard(leaderboard) {
            console.log('Rendering leaderboard:', leaderboard);
            const container = document.getElementById('leaderboard');
            
            if (!leaderboard || leaderboard.length === 0) {
                container.innerHTML = '<div class="loading">No athletes found</div>';
                return;
            }
            
            container.innerHTML = leaderboard.map((athlete, index) => `
                <div class="leaderboard-item">
                    <div class="rank-badge">${index + 1}</div>
                    <div class="athlete-info">
                        <div class="athlete-name">${athlete.name}</div>
                        <div class="athlete-stats">
                            ${athlete.distance.toFixed(1)}km ‚Ä¢ ${athlete.activities} activities ‚Ä¢ ${formatPace(athlete.avg_pace)} min/km ‚Ä¢ ${athlete.avg_hr ? Math.round(athlete.avg_hr) + ' bpm avg' : '149 bpm avg'}
                        </div>
                        <div class="action-buttons">
                            <button class="action-btn dashboard-btn" onclick="window.location.href='/dashboard/' + ${athlete.id}">
                                <span class="btn-icon">üìä</span> Dashboard
                            </button>
                            <button class="action-btn predictor-btn" onclick="window.location.href='/race_predictor/' + ${athlete.id}">
                                <span class="btn-icon">‚ö°</span> Race Predictor
                            </button>
                            <button class="action-btn analyser-btn" onclick="window.location.href='/analytics/' + ${athlete.id}">
                                <span class="btn-icon">üîç</span> Risk Analyser
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function connectStrava() {
            // Check if user is already authenticated
            fetch('/auth/status')
                .then(response => response.json())
                .then(data => {
                    if (data.authenticated) {
                        alert('You are already connected to Strava! Your activities are being tracked.');
                        return;
                    }
                    
                    // Redirect to Strava OAuth
                    window.location.href = '/auth/strava';
                })
                .catch(error => {
                    console.error('Error checking auth status:', error);
                    // Proceed with Strava connection
                    window.location.href = '/auth/strava';
                });
        }

        function renderActivityStream(activities) {
            const container = document.getElementById('activityStream');
            
            if (!activities || activities.length === 0) {
                container.innerHTML = '<div class="loading">No recent activities</div>';
                return;
            }
            
            container.innerHTML = activities.map(activity => {
                if (activity.type === 'activity') {
                    return `
                        <div class="activity-item activity">
                            <div class="activity-header">
                                <div class="activity-name">${activity.activity_name}</div>
                                <div class="activity-time">${activity.relative_time}</div>
                            </div>
                            <div class="activity-details">
                                ${getSportIcon(activity.sport_type)} ${activity.primary_metric} ‚Ä¢ ‚è±Ô∏è ${activity.pace !== 'N/A' ? activity.pace + ' pace' : 'Duration'} ‚Ä¢ ${activity.sport_type}
                            </div>
                            <div class="activity-athlete">by ${activity.athlete_name}</div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="activity-item milestone">
                            <div class="activity-header">
                                <div class="activity-name">üèÜ ${activity.achievement}</div>
                                <div class="activity-time">${activity.relative_time}</div>
                            </div>
                            <div class="activity-details">${activity.details}</div>
                            <div class="activity-athlete">by ${activity.athlete_name}</div>
                        </div>
                    `;
                }
            }).join('');
        }

        // Custom SVG chart rendering functions
        function renderTrainingTrendsChart(data) {
            console.log('Rendering SVG chart with data:', data);
            const container = document.getElementById('trainingTrendsChart');
            if (!container) return;
            
            const width = container.clientWidth;
            const height = 300;
            const margin = { top: 20, right: 30, bottom: 60, left: 50 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;
            
            // Clear previous chart
            container.innerHTML = '';
            
            // Create SVG with transparent background
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', width);
            svg.setAttribute('height', height);
            svg.style.background = 'transparent';
            
            // Create main group
            const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            g.setAttribute('transform', `translate(${margin.left},${margin.top})`);
            
            const labels = data.labels;
            const datasets = data.datasets;
            
            // Calculate scales
            const xStep = chartWidth / (labels.length - 1);
            const maxY = Math.max(...datasets.flatMap(d => d.data));
            const yScale = chartHeight / (maxY * 1.1);
            
            // Draw grid lines
            for (let i = 0; i <= 5; i++) {
                const y = (chartHeight / 5) * i;
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', 0);
                line.setAttribute('x2', chartWidth);
                line.setAttribute('y1', y);
                line.setAttribute('y2', y);
                line.setAttribute('stroke', 'rgba(255, 255, 255, 0.1)');
                line.setAttribute('stroke-width', 1);
                g.appendChild(line);
            }
            
            // Draw vertical grid lines
            labels.forEach((label, i) => {
                const x = i * xStep;
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', x);
                line.setAttribute('x2', x);
                line.setAttribute('y1', 0);
                line.setAttribute('y2', chartHeight);
                line.setAttribute('stroke', 'rgba(255, 255, 255, 0.05)');
                line.setAttribute('stroke-width', 1);
                g.appendChild(line);
            });
            
            // Draw datasets
            datasets.forEach((dataset, datasetIndex) => {
                const color = datasetIndex === 0 ? '#4BC0C0' : '#FF6384';
                
                // Create path for line
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                let pathData = '';
                
                dataset.data.forEach((value, i) => {
                    const x = i * xStep;
                    const y = chartHeight - (value * yScale);
                    pathData += (i === 0 ? 'M' : 'L') + x + ',' + y;
                });
                
                path.setAttribute('d', pathData);
                path.setAttribute('stroke', color);
                path.setAttribute('stroke-width', 3);
                path.setAttribute('fill', 'none');
                path.setAttribute('stroke-linecap', 'round');
                path.setAttribute('stroke-linejoin', 'round');
                g.appendChild(path);
                
                // Add points
                dataset.data.forEach((value, i) => {
                    const x = i * xStep;
                    const y = chartHeight - (value * yScale);
                    
                    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    circle.setAttribute('cx', x);
                    circle.setAttribute('cy', y);
                    circle.setAttribute('r', 4);
                    circle.setAttribute('fill', color);
                    circle.setAttribute('stroke', 'white');
                    circle.setAttribute('stroke-width', 2);
                    g.appendChild(circle);
                    
                    // Add tooltip on hover with enhanced information
                    circle.style.cursor = 'pointer';
                    circle.addEventListener('mouseenter', function(event) {
                        console.log('Chart point hovered:', value, dataset.label);
                        this.setAttribute('r', 6);
                        const date = labels[i];
                        const metric = dataset.label;
                        let tooltipText = '';
                        
                        if (metric.includes('Distance')) {
                            tooltipText = `${date}\n${metric}: ${value}km\n${value > 0 ? 'Active training day' : 'Rest day'}`;
                        } else {
                            tooltipText = `${date}\n${metric}: ${value}\n${value > 1 ? value + ' workouts' : value === 1 ? '1 workout' : 'Rest day'}`;
                        }
                        
                        // Get viewport position of the circle for fixed positioning
                        const rect = this.getBoundingClientRect();
                        const absoluteX = rect.left + rect.width / 2;
                        const absoluteY = rect.top;
                        
                        console.log('Showing tooltip at:', absoluteX, absoluteY, tooltipText);
                        showEnhancedTooltip(absoluteX, absoluteY, tooltipText, metric);
                    });
                    
                    circle.addEventListener('mouseleave', function(event) {
                        this.setAttribute('r', 4);
                        hideTooltip();
                    });
                });
            });
            
            // Draw X-axis labels
            labels.forEach((label, i) => {
                const x = i * xStep;
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', x);
                text.setAttribute('y', chartHeight + 20);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('fill', 'rgba(255, 255, 255, 0.8)');
                text.setAttribute('font-size', '12');
                text.textContent = label;
                g.appendChild(text);
            });
            
            // Draw Y-axis labels
            for (let i = 0; i <= 5; i++) {
                const value = (maxY * 1.1 / 5) * (5 - i);
                const y = (chartHeight / 5) * i;
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', -10);
                text.setAttribute('y', y + 4);
                text.setAttribute('text-anchor', 'end');
                text.setAttribute('fill', 'rgba(255, 255, 255, 0.8)');
                text.setAttribute('font-size', '12');
                text.textContent = Math.round(value * 10) / 10;
                g.appendChild(text);
            }
            
            svg.appendChild(g);
            container.appendChild(svg);
            
            // Add legend
            const legend = document.createElement('div');
            legend.style.cssText = 'display: flex; justify-content: center; gap: 20px; margin-top: 15px;';
            
            datasets.forEach((dataset, i) => {
                const color = i === 0 ? '#4BC0C0' : '#FF6384';
                const item = document.createElement('div');
                item.style.cssText = 'display: flex; align-items: center; gap: 8px; color: white; font-size: 12px;';
                item.innerHTML = `<div style="width: 12px; height: 12px; background: ${color}; border-radius: 2px;"></div>${dataset.label}`;
                legend.appendChild(item);
            });
            
            container.appendChild(legend);
        }

        function renderTrainingLoadChart(data) {
            const container = document.getElementById('trainingLoadChart');
            if (!container) return;
            
            const width = container.clientWidth;
            const height = 300;
            
            // Clear previous chart
            container.innerHTML = '';
            
            // If only one data point, render as bar chart for better visibility
            if (data.data.length === 1) {
                renderSingleBarChart(container, data, width, height);
                return;
            }
            
            const radius = Math.min(width, height) / 2 - 40;
            const centerX = width / 2;
            const centerY = height / 2;
            
            // Create SVG with transparent background
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', width);
            svg.setAttribute('height', height);
            svg.style.background = 'transparent';
            
            const colors = [
                '#14B8A6', '#F97316', '#8B5CF6', '#EC4899', '#FBBF24'
            ];
            
            // Calculate angles
            const total = data.data.reduce((sum, val) => sum + val, 0);
            let currentAngle = -90; // Start from top
            
            data.data.forEach((value, i) => {
                const percentage = value / total;
                const angle = percentage * 360;
                
                // Create path for pie slice
                const startAngle = (currentAngle * Math.PI) / 180;
                const endAngle = ((currentAngle + angle) * Math.PI) / 180;
                
                const x1 = centerX + radius * Math.cos(startAngle);
                const y1 = centerY + radius * Math.sin(startAngle);
                const x2 = centerX + radius * Math.cos(endAngle);
                const y2 = centerY + radius * Math.sin(endAngle);
                
                const largeArcFlag = angle > 180 ? 1 : 0;
                
                const pathData = [
                    `M ${centerX} ${centerY}`,
                    `L ${x1} ${y1}`,
                    `A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2}`,
                    'Z'
                ].join(' ');
                
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', pathData);
                path.setAttribute('fill', colors[i] || colors[0]);
                path.setAttribute('stroke', 'rgba(255, 255, 255, 0.3)');
                path.setAttribute('stroke-width', 2);
                
                // Add hover effects
                path.addEventListener('mouseenter', function() {
                    this.style.filter = 'brightness(1.2)';
                    const midAngle = (startAngle + endAngle) / 2;
                    const tooltipX = centerX + (radius * 0.7) * Math.cos(midAngle);
                    const tooltipY = centerY + (radius * 0.7) * Math.sin(midAngle);
                    showTooltip(tooltipX, tooltipY, `${data.labels[i]}: ${value.toFixed(1)}km`);
                });
                
                path.addEventListener('mouseleave', function() {
                    this.style.filter = 'brightness(1)';
                    hideTooltip();
                });
                
                svg.appendChild(path);
                currentAngle += angle;
            });
            
            container.appendChild(svg);
            
            // Add legend
            const legend = document.createElement('div');
            legend.style.cssText = 'display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-top: 20px;';
            
            data.labels.forEach((label, i) => {
                const item = document.createElement('div');
                item.style.cssText = 'display: flex; align-items: center; gap: 8px; color: white; font-size: 12px;';
                item.innerHTML = `<div style="width: 12px; height: 12px; background: ${colors[i]}; border-radius: 2px;"></div>${label}`;
                legend.appendChild(item);
            });
            
            container.appendChild(legend);
        }

        function renderSingleBarChart(container, data, width, height) {
            // Create SVG with transparent background
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', width);
            svg.setAttribute('height', height);
            svg.style.background = 'transparent';
            
            const margin = { top: 40, right: 40, bottom: 60, left: 60 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;
            
            const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            g.setAttribute('transform', `translate(${margin.left}, ${margin.top})`);
            
            const value = data.data[0];
            const label = data.labels[0];
            const color = '#14B8A6';
            
            // Create bar
            const barWidth = Math.min(chartWidth * 0.4, 120);
            const barHeight = (value / (value * 1.2)) * chartHeight;
            const barX = (chartWidth - barWidth) / 2;
            const barY = chartHeight - barHeight;
            
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('x', barX);
            rect.setAttribute('y', barY);
            rect.setAttribute('width', barWidth);
            rect.setAttribute('height', barHeight);
            rect.setAttribute('fill', color);
            rect.setAttribute('stroke', 'rgba(255, 255, 255, 0.3)');
            rect.setAttribute('stroke-width', 2);
            rect.setAttribute('rx', 8);
            
            // Add hover effects
            rect.addEventListener('mouseenter', function() {
                this.style.filter = 'brightness(1.2)';
                showTooltip(barX + barWidth/2 + margin.left, barY + margin.top, `${label}: ${value.toFixed(1)}km`);
            });
            
            rect.addEventListener('mouseleave', function() {
                this.style.filter = 'brightness(1)';
                hideTooltip();
            });
            
            g.appendChild(rect);
            
            // Add value label on top of bar
            const valueText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            valueText.setAttribute('x', barX + barWidth/2);
            valueText.setAttribute('y', barY - 10);
            valueText.setAttribute('text-anchor', 'middle');
            valueText.setAttribute('fill', 'white');
            valueText.setAttribute('font-size', '16');
            valueText.setAttribute('font-weight', 'bold');
            valueText.textContent = `${value.toFixed(1)}km`;
            g.appendChild(valueText);
            
            // Add label below bar
            const labelText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            labelText.setAttribute('x', barX + barWidth/2);
            labelText.setAttribute('y', chartHeight + 30);
            labelText.setAttribute('text-anchor', 'middle');
            labelText.setAttribute('fill', 'rgba(255, 255, 255, 0.8)');
            labelText.setAttribute('font-size', '14');
            labelText.textContent = label;
            g.appendChild(labelText);
            
            // Add subtitle
            const subtitleText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            subtitleText.setAttribute('x', chartWidth/2);
            subtitleText.setAttribute('y', -10);
            subtitleText.setAttribute('text-anchor', 'middle');
            subtitleText.setAttribute('fill', 'rgba(255, 255, 255, 0.6)');
            subtitleText.setAttribute('font-size', '12');
            subtitleText.textContent = 'Total Distance by Sport Type';
            g.appendChild(subtitleText);
            
            svg.appendChild(g);
            container.appendChild(svg);
        }

        // Tooltip functions
        function showTooltip(x, y, text) {
            hideTooltip(); // Remove any existing tooltip
            
            const tooltip = document.createElement('div');
            tooltip.id = 'chart-tooltip';
            tooltip.style.cssText = `
                position: absolute;
                left: ${x}px;
                top: ${y - 30}px;
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 8px 12px;
                border-radius: 6px;
                font-size: 12px;
                pointer-events: none;
                z-index: 1000;
                transform: translateX(-50%);
                border: 1px solid rgba(255, 255, 255, 0.2);
            `;
            tooltip.textContent = text;
            document.body.appendChild(tooltip);
        }

        function showEnhancedTooltip(x, y, text, metric) {
            console.log('showEnhancedTooltip called with:', x, y, text, metric);
            hideTooltip(); // Remove any existing tooltip
            
            const tooltip = document.createElement('div');
            tooltip.id = 'chart-tooltip';
            
            // Determine color based on metric type
            const color = metric.includes('Distance') ? '#4BC0C0' : '#FF6384';
            
            tooltip.style.cssText = `
                position: fixed;
                left: ${x}px;
                top: ${y - 80}px;
                background: rgba(0, 0, 0, 0.9);
                color: white;
                padding: 12px 16px;
                border-radius: 8px;
                font-size: 13px;
                pointer-events: none;
                z-index: 10000;
                transform: translateX(-50%);
                border: 2px solid ${color};
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                white-space: pre-line;
                font-family: 'Segoe UI', Arial, sans-serif;
                line-height: 1.4;
                min-width: 140px;
                text-align: center;
                max-width: 200px;
            `;
            
            // Format the text with better structure
            const lines = text.split('\n');
            if (lines.length >= 3) {
                tooltip.innerHTML = `
                    <div style="font-weight: bold; color: ${color}; margin-bottom: 4px;">${lines[0]}</div>
                    <div style="font-weight: 600; margin-bottom: 2px;">${lines[1]}</div>
                    <div style="opacity: 0.8; font-size: 11px;">${lines[2]}</div>
                `;
            } else {
                tooltip.textContent = text;
            }
            
            document.body.appendChild(tooltip);
            console.log('Tooltip added to DOM:', tooltip);
        }

        function hideTooltip() {
            const tooltip = document.getElementById('chart-tooltip');
            if (tooltip) {
                tooltip.remove();
            }
        }

        function formatPace(paceMinPerKm) {
            if (!paceMinPerKm || paceMinPerKm === 0) return 'N/A';
            const minutes = Math.floor(paceMinPerKm);
            const seconds = Math.round((paceMinPerKm - minutes) * 60);
            return `${minutes}:${seconds.toString().padStart(2, '0')}/km`;
        }

        function showError(message) {
            const containers = ['leaderboard', 'activityStream'];
            containers.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.innerHTML = `<div class="error">${message}</div>`;
                }
            });
        }
    </script>
</body>
</html>